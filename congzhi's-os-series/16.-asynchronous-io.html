<!DOCTYPE html> <html><head>
		<title>16. Asynchronous IO</title>
		<base href="../">
		<meta id="root-path" root-path="../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Congzhi's Notes Vault - 16. Asynchronous IO">
		<meta property="og:title" content="16. Asynchronous IO">
		<meta property="og:description" content="Congzhi's Notes Vault - 16. Asynchronous IO">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://congzhi.wiki/congzhi's-os-series/16.-asynchronous-io.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="Congzhi's Notes Vault">
		<meta name="author" content="Congzhi"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://congzhi.wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles">mjx-c.mjx-c1D442.TEX-I::before { padding: 0.704em 0.763em 0.022em 0px; content: "O"; }
mjx-c.mjx-c1D459.TEX-I::before { padding: 0.694em 0.298em 0.011em 0px; content: "l"; }
mjx-c.mjx-c1D45C.TEX-I::before { padding: 0.441em 0.485em 0.011em 0px; content: "o"; }
mjx-c.mjx-c1D454.TEX-I::before { padding: 0.442em 0.477em 0.205em 0px; content: "g"; }
mjx-c.mjx-c4B::before { padding: 0.683em 0.778em 0px 0px; content: "K"; }
mjx-c.mjx-c46::before { padding: 0.68em 0.653em 0px 0px; content: "F"; }
mjx-c.mjx-c7A::before { padding: 0.431em 0.444em 0px 0px; content: "z"; }
mjx-c.mjx-cD7::before { padding: 0.491em 0.778em 0px 0px; content: "×"; }
mjx-msup { display: inline-block; text-align: left; }
mjx-c.mjx-c4D::before { padding: 0.683em 0.917em 0px 0px; content: "M"; }
mjx-c.mjx-c79::before { padding: 0.431em 0.528em 0.204em 0px; content: "y"; }
mjx-c.mjx-c42::before { padding: 0.683em 0.708em 0px 0px; content: "B"; }
mjx-c.mjx-c73::before { padding: 0.448em 0.394em 0.011em 0px; content: "s"; }
mjx-c.mjx-c38::before { padding: 0.666em 0.5em 0.022em 0px; content: "8"; }
mjx-c.mjx-c36::before { padding: 0.666em 0.5em 0.022em 0px; content: "6"; }
mjx-c.mjx-c1D43A.TEX-I::before { padding: 0.705em 0.786em 0.022em 0px; content: "G"; }
mjx-c.mjx-c1D43E.TEX-I::before { padding: 0.683em 0.889em 0px 0px; content: "K"; }
mjx-c.mjx-c47::before { padding: 0.705em 0.785em 0.022em 0px; content: "G"; }
mjx-c.mjx-c70::before { padding: 0.442em 0.556em 0.194em 0px; content: "p"; }
mjx-c.mjx-c2217::before { padding: 0.465em 0.5em 0px 0px; content: "∗"; }
mjx-c.mjx-c35::before { padding: 0.666em 0.5em 0.022em 0px; content: "5"; }
mjx-c.mjx-c1D45A.TEX-I::before { padding: 0.442em 0.878em 0.011em 0px; content: "m"; }
mjx-c.mjx-c1D45F.TEX-I::before { padding: 0.442em 0.451em 0.011em 0px; content: "r"; }
mjx-c.mjx-c1D460.TEX-I::before { padding: 0.442em 0.469em 0.01em 0px; content: "s"; }
mjx-c.mjx-c1D436.TEX-I::before { padding: 0.705em 0.76em 0.022em 0px; content: "C"; }
mjx-c.mjx-c1D457.TEX-I::before { padding: 0.661em 0.412em 0.204em 0px; content: "j"; }
mjx-c.mjx-c1D456.TEX-I::before { padding: 0.661em 0.345em 0.011em 0px; content: "i"; }
mjx-c.mjx-c1D435.TEX-I::before { padding: 0.683em 0.759em 0px 0px; content: "B"; }
mjx-c.mjx-c1D441.TEX-I::before { padding: 0.683em 0.888em 0px 0px; content: "N"; }
mjx-mtext { display: inline-block; text-align: left; }
mjx-c.mjx-c44::before { padding: 0.683em 0.764em 0px 0px; content: "D"; }
mjx-c.mjx-c65::before { padding: 0.448em 0.444em 0.011em 0px; content: "e"; }
mjx-c.mjx-c61::before { padding: 0.448em 0.5em 0.011em 0px; content: "a"; }
mjx-c.mjx-c64::before { padding: 0.694em 0.556em 0.011em 0px; content: "d"; }
mjx-c.mjx-c6C::before { padding: 0.694em 0.278em 0px 0px; content: "l"; }
mjx-c.mjx-c69::before { padding: 0.669em 0.278em 0px 0px; content: "i"; }
mjx-c.mjx-c6E::before { padding: 0.442em 0.556em 0px 0px; content: "n"; }
mjx-c.mjx-c20::before { padding: 0px 0.25em 0px 0px; content: " "; }
mjx-c.mjx-c54::before { padding: 0.677em 0.722em 0px 0px; content: "T"; }
mjx-c.mjx-c6D::before { padding: 0.442em 0.833em 0px 0px; content: "m"; }
mjx-c.mjx-c2D::before { padding: 0.252em 0.333em 0px 0px; content: "-"; }
mjx-c.mjx-c43::before { padding: 0.705em 0.722em 0.021em 0px; content: "C"; }
mjx-c.mjx-c75::before { padding: 0.442em 0.556em 0.011em 0px; content: "u"; }
mjx-c.mjx-c72::before { padding: 0.442em 0.392em 0px 0px; content: "r"; }
mjx-c.mjx-c74::before { padding: 0.615em 0.389em 0.01em 0px; content: "t"; }
mjx-c.mjx-c53::before { padding: 0.705em 0.556em 0.022em 0px; content: "S"; }
mjx-c.mjx-c63::before { padding: 0.448em 0.444em 0.011em 0px; content: "c"; }
mjx-c.mjx-c6B::before { padding: 0.694em 0.528em 0px 0px; content: "k"; }
mjx-c.mjx-c52::before { padding: 0.683em 0.736em 0.022em 0px; content: "R"; }
mjx-c.mjx-c67::before { padding: 0.453em 0.5em 0.206em 0px; content: "g"; }
mjx-c.mjx-c45::before { padding: 0.68em 0.681em 0px 0px; content: "E"; }
mjx-c.mjx-c78::before { padding: 0.431em 0.528em 0px 0px; content: "x"; }
mjx-c.mjx-c6F::before { padding: 0.448em 0.5em 0.01em 0px; content: "o"; }
mjx-c.mjx-c2C::before { padding: 0.121em 0.278em 0.194em 0px; content: ","; }
mjx-c.mjx-c34::before { padding: 0.677em 0.5em 0px 0px; content: "4"; }
mjx-c.mjx-c37::before { padding: 0.676em 0.5em 0.022em 0px; content: "7"; }
mjx-c.mjx-c30::before { padding: 0.666em 0.5em 0.022em 0px; content: "0"; }
mjx-c.mjx-c220F.TEX-S2::before { padding: 0.95em 1.278em 0.45em 0px; content: "∏"; }
mjx-c.mjx-c1D447.TEX-I::before { padding: 0.677em 0.704em 0px 0px; content: "T"; }
mjx-c.mjx-c2264::before { padding: 0.636em 0.778em 0.138em 0px; content: "≤"; }
mjx-munderover { display: inline-block; text-align: left; }
mjx-munderover:not([limits="false"]) { padding-top: 0.1em; }
mjx-munderover:not([limits="false"]) > * { display: block; }
mjx-msubsup { display: inline-block; text-align: left; }
mjx-script { display: inline-block; padding-right: 0.05em; padding-left: 0.033em; }
mjx-script > mjx-spacer { display: block; }
mjx-c.mjx-c1D70F.TEX-I::before { padding: 0.431em 0.517em 0.013em 0px; content: "τ"; }
mjx-c.mjx-c1D458.TEX-I::before { padding: 0.694em 0.521em 0.011em 0px; content: "k"; }
mjx-c.mjx-c1D450.TEX-I::before { padding: 0.442em 0.433em 0.011em 0px; content: "c"; }
mjx-c.mjx-c1D448.TEX-I::before { padding: 0.683em 0.767em 0.022em 0px; content: "U"; }
mjx-c.mjx-c2211.TEX-S2::before { padding: 0.95em 1.444em 0.45em 0px; content: "∑"; }
mjx-c.mjx-c3C::before { padding: 0.54em 0.778em 0.04em 0px; content: "<"; }
mjx-container[jax="CHTML"] { line-height: 0; }
mjx-container [space="1"] { margin-left: 0.111em; }
mjx-container [space="2"] { margin-left: 0.167em; }
mjx-container [space="3"] { margin-left: 0.222em; }
mjx-container [space="4"] { margin-left: 0.278em; }
mjx-container [space="5"] { margin-left: 0.333em; }
mjx-container [rspace="1"] { margin-right: 0.111em; }
mjx-container [rspace="2"] { margin-right: 0.167em; }
mjx-container [rspace="3"] { margin-right: 0.222em; }
mjx-container [rspace="4"] { margin-right: 0.278em; }
mjx-container [rspace="5"] { margin-right: 0.333em; }
mjx-container [size="s"] { font-size: 70.7%; }
mjx-container [size="ss"] { font-size: 50%; }
mjx-container [size="Tn"] { font-size: 60%; }
mjx-container [size="sm"] { font-size: 85%; }
mjx-container [size="lg"] { font-size: 120%; }
mjx-container [size="Lg"] { font-size: 144%; }
mjx-container [size="LG"] { font-size: 173%; }
mjx-container [size="hg"] { font-size: 207%; }
mjx-container [size="HG"] { font-size: 249%; }
mjx-container [width="full"] { width: 100%; }
mjx-box { display: inline-block; }
mjx-block { display: block; }
mjx-itable { display: inline-table; }
mjx-row { display: table-row; }
mjx-row > * { display: table-cell; }
mjx-mtext { display: inline-block; }
mjx-mstyle { display: inline-block; }
mjx-merror { display: inline-block; color: red; background-color: yellow; }
mjx-mphantom { visibility: hidden; }
mjx-assistive-mml { top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; display: block !important; width: auto !important; overflow: hidden !important; }
mjx-assistive-mml[display="block"] { width: 100% !important; }
mjx-math { display: inline-block; text-align: left; line-height: 0; text-indent: 0px; font-style: normal; font-weight: normal; font-size: 100%; letter-spacing: normal; border-collapse: collapse; overflow-wrap: normal; word-spacing: normal; white-space: nowrap; direction: ltr; padding: 1px 0px; }
mjx-container[jax="CHTML"][display="true"] { display: block; text-align: center; margin: 1em 0px; }
mjx-container[jax="CHTML"][display="true"][width="full"] { display: flex; }
mjx-container[jax="CHTML"][display="true"] mjx-math { padding: 0px; }
mjx-container[jax="CHTML"][justify="left"] { text-align: left; }
mjx-container[jax="CHTML"][justify="right"] { text-align: right; }
mjx-mi { display: inline-block; text-align: left; }
mjx-c { display: inline-block; }
mjx-utext { display: inline-block; padding: 0.75em 0px 0.2em; }
mjx-mo { display: inline-block; text-align: left; }
mjx-stretchy-h { display: inline-table; width: 100%; }
mjx-stretchy-h > * { display: table-cell; width: 0px; }
mjx-stretchy-h > * > mjx-c { display: inline-block; transform: scaleX(1); }
mjx-stretchy-h > * > mjx-c::before { display: inline-block; width: initial; }
mjx-stretchy-h > mjx-ext { overflow: clip visible; width: 100%; }
mjx-stretchy-h > mjx-ext > mjx-c::before { transform: scaleX(500); }
mjx-stretchy-h > mjx-ext > mjx-c { width: 0px; }
mjx-stretchy-h > mjx-beg > mjx-c { margin-right: -0.1em; }
mjx-stretchy-h > mjx-end > mjx-c { margin-left: -0.1em; }
mjx-stretchy-v { display: inline-block; }
mjx-stretchy-v > * { display: block; }
mjx-stretchy-v > mjx-beg { height: 0px; }
mjx-stretchy-v > mjx-end > mjx-c { display: block; }
mjx-stretchy-v > * > mjx-c { transform: scaleY(1); transform-origin: left center; overflow: hidden; }
mjx-stretchy-v > mjx-ext { display: block; height: 100%; box-sizing: border-box; border: 0px solid transparent; overflow: visible clip; }
mjx-stretchy-v > mjx-ext > mjx-c::before { width: initial; box-sizing: border-box; }
mjx-stretchy-v > mjx-ext > mjx-c { transform: scaleY(500) translateY(0.075em); overflow: visible; }
mjx-mark { display: inline-block; height: 0px; }
mjx-mfrac { display: inline-block; text-align: left; }
mjx-frac { display: inline-block; vertical-align: 0.17em; padding: 0px 0.22em; }
mjx-frac[type="d"] { vertical-align: 0.04em; }
mjx-frac[delims] { padding: 0px 0.1em; }
mjx-frac[atop] { padding: 0px 0.12em; }
mjx-frac[atop][delims] { padding: 0px; }
mjx-dtable { display: inline-table; width: 100%; }
mjx-dtable > * { font-size: 2000%; }
mjx-dbox { display: block; font-size: 5%; }
mjx-num { display: block; text-align: center; }
mjx-den { display: block; text-align: center; }
mjx-mfrac[bevelled] > mjx-num { display: inline-block; }
mjx-mfrac[bevelled] > mjx-den { display: inline-block; }
mjx-den[align="right"], mjx-num[align="right"] { text-align: right; }
mjx-den[align="left"], mjx-num[align="left"] { text-align: left; }
mjx-nstrut { display: inline-block; height: 0.054em; width: 0px; vertical-align: -0.054em; }
mjx-nstrut[type="d"] { height: 0.217em; vertical-align: -0.217em; }
mjx-dstrut { display: inline-block; height: 0.505em; width: 0px; }
mjx-dstrut[type="d"] { height: 0.726em; }
mjx-line { display: block; box-sizing: border-box; min-height: 1px; height: 0.06em; border-top: 0.06em solid; margin: 0.06em -0.1em; overflow: hidden; }
mjx-line[type="d"] { margin: 0.18em -0.1em; }
mjx-mrow { display: inline-block; text-align: left; }
mjx-mn { display: inline-block; text-align: left; }
mjx-msub { display: inline-block; text-align: left; }
mjx-texatom { display: inline-block; text-align: left; }
mjx-c::before { display: block; width: 0px; }
.MJX-TEX { font-family: MJXZERO, MJXTEX; }
.TEX-B { font-family: MJXZERO, MJXTEX-B; }
.TEX-I { font-family: MJXZERO, MJXTEX-I; }
.TEX-MI { font-family: MJXZERO, MJXTEX-MI; }
.TEX-BI { font-family: MJXZERO, MJXTEX-BI; }
.TEX-S1 { font-family: MJXZERO, MJXTEX-S1; }
.TEX-S2 { font-family: MJXZERO, MJXTEX-S2; }
.TEX-S3 { font-family: MJXZERO, MJXTEX-S3; }
.TEX-S4 { font-family: MJXZERO, MJXTEX-S4; }
.TEX-A { font-family: MJXZERO, MJXTEX-A; }
.TEX-C { font-family: MJXZERO, MJXTEX-C; }
.TEX-CB { font-family: MJXZERO, MJXTEX-CB; }
.TEX-FR { font-family: MJXZERO, MJXTEX-FR; }
.TEX-FRB { font-family: MJXZERO, MJXTEX-FRB; }
.TEX-SS { font-family: MJXZERO, MJXTEX-SS; }
.TEX-SSB { font-family: MJXZERO, MJXTEX-SSB; }
.TEX-SSI { font-family: MJXZERO, MJXTEX-SSI; }
.TEX-SC { font-family: MJXZERO, MJXTEX-SC; }
.TEX-T { font-family: MJXZERO, MJXTEX-T; }
.TEX-V { font-family: MJXZERO, MJXTEX-V; }
.TEX-VB { font-family: MJXZERO, MJXTEX-VB; }
mjx-stretchy-v mjx-c, mjx-stretchy-h mjx-c { font-family: MJXZERO, MJXTEX-S1, MJXTEX-S4, MJXTEX, MJXTEX-A !important; }
@font-face { font-family: MJXZERO; src: url("lib/fonts/mathjax_zero.woff") format("woff"); }
@font-face { font-family: MJXTEX; src: url("lib/fonts/mathjax_main-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-B; src: url("lib/fonts/mathjax_main-bold.woff") format("woff"); }
@font-face { font-family: MJXTEX-I; src: url("lib/fonts/mathjax_math-italic.woff") format("woff"); }
@font-face { font-family: MJXTEX-MI; src: url("lib/fonts/mathjax_main-italic.woff") format("woff"); }
@font-face { font-family: MJXTEX-BI; src: url("lib/fonts/mathjax_math-bolditalic.woff") format("woff"); }
@font-face { font-family: MJXTEX-S1; src: url("lib/fonts/mathjax_size1-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-S2; src: url("lib/fonts/mathjax_size2-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-S3; src: url("lib/fonts/mathjax_size3-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-S4; src: url("lib/fonts/mathjax_size4-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-A; src: url("lib/fonts/mathjax_ams-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-C; src: url("lib/fonts/mathjax_calligraphic-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-CB; src: url("lib/fonts/mathjax_calligraphic-bold.woff") format("woff"); }
@font-face { font-family: MJXTEX-FR; src: url("lib/fonts/mathjax_fraktur-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-FRB; src: url("lib/fonts/mathjax_fraktur-bold.woff") format("woff"); }
@font-face { font-family: MJXTEX-SS; src: url("lib/fonts/mathjax_sansserif-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-SSB; src: url("lib/fonts/mathjax_sansserif-bold.woff") format("woff"); }
@font-face { font-family: MJXTEX-SSI; src: url("lib/fonts/mathjax_sansserif-italic.woff") format("woff"); }
@font-face { font-family: MJXTEX-SC; src: url("lib/fonts/mathjax_script-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-T; src: url("lib/fonts/mathjax_typewriter-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-V; src: url("lib/fonts/mathjax_vector-regular.woff") format("woff"); }
@font-face { font-family: MJXTEX-VB; src: url("lib/fonts/mathjax_vector-bold.woff") format("woff"); }
mjx-c.mjx-c1D445.TEX-I::before { padding: 0.683em 0.759em 0.021em 0px; content: "R"; }
mjx-c.mjx-c3D::before { padding: 0.583em 0.778em 0.082em 0px; content: "="; }
mjx-c.mjx-c28::before { padding: 0.75em 0.389em 0.25em 0px; content: "("; }
mjx-c.mjx-c1D44A.TEX-I::before { padding: 0.683em 1.048em 0.022em 0px; content: "W"; }
mjx-c.mjx-c2B::before { padding: 0.583em 0.778em 0.082em 0px; content: "+"; }
mjx-c.mjx-c1D446.TEX-I::before { padding: 0.705em 0.645em 0.022em 0px; content: "S"; }
mjx-c.mjx-c29::before { padding: 0.75em 0.389em 0.25em 0px; content: ")"; }
mjx-c.mjx-c31::before { padding: 0.666em 0.5em 0px 0px; content: "1"; }
mjx-c.mjx-c1D444.TEX-I::before { padding: 0.704em 0.791em 0.194em 0px; content: "Q"; }
mjx-c.mjx-c3E::before { padding: 0.54em 0.778em 0.04em 0px; content: ">"; }
mjx-c.mjx-c32::before { padding: 0.666em 0.5em 0px 0px; content: "2"; }
mjx-c.mjx-c2E::before { padding: 0.12em 0.278em 0px 0px; content: "."; }
mjx-c.mjx-c1D45B.TEX-I::before { padding: 0.442em 0.6em 0.011em 0px; content: "n"; }
mjx-c.mjx-c2212::before { padding: 0.583em 0.778em 0.082em 0px; content: "−"; }
mjx-c.mjx-c1D443.TEX-I::before { padding: 0.683em 0.751em 0px 0px; content: "P"; }
mjx-c.mjx-c33::before { padding: 0.665em 0.5em 0.022em 0px; content: "3"; }
</style><pre class="frontmatter language-yaml" tabindex="0" style="display: none;"><code class="language-yaml is-loaded"><span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> OS</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="16. Asynchronous IO"><ol start="16">
<li dir="auto">Asynchronous IO</li>
</ol></h1><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg></div><div class="callout-title-inner">第一遍重写中</div></div></div></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="warning" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-alert-triangle"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg></div><div class="callout-title-inner">需要注意！</div></div><div class="callout-content">
<p dir="auto">本章内容有待明晰同步IO和异步IO的区别。内容暂未修正。</p>
</div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第一课 Select, Poll and Epoll" dir="auto" class="heading" id="第一课_Select,_Poll_and_Epoll"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第一课 Select, Poll and Epoll</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.1 What is Asynchronous I/O Anyway?" dir="auto" class="heading" id="1.1_What_is_Asynchronous_I/O_Anyway?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1 What is Asynchronous I/O Anyway?</h3><div class="heading-children"><div class="el-p"><p dir="auto">异步——Asynchronous这个单词由否定前缀 "A-" ，表示一起、同的前缀 "SYN-" 和表示时间的希腊词根 "CHRON" 构成。字面意思就是不同时/不同步的意思，也就是我们所说的异步。当然，你也可以理解为随机。</p></div><div class="el-p"><p dir="auto">由于I/O完成的时间是随机的，我们总会担心I/O操作完成后的中断被错过，我们可能就会想到阻塞/自旋等待I/O操作的完成，这种等待I/O操作完成的操作就被称为同步I/O。但这段阻塞/自旋的时间就会被白白浪费，这不是我们想要的。</p></div><div class="el-p"><p dir="auto">而通过异步I/O，CPU就可以在I/O操作完成前继续执行其他任务，不需要阻塞等待整个I/O操作完成。其实就相当于等公交，你并不会在等公交时傻傻地盯着远处一直看，而是在等待的过程中做自己的事情，当公交车到了时，司机会提醒你上车，这时才会停下手上的活去挤公交。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.1.1 Resource Wasting Should NOT be Allowed" dir="auto" class="heading" id="1.1.1_Resource_Wasting_Should_NOT_be_Allowed"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1.1 Resource Wasting Should NOT be Allowed</h4><div class="heading-children"><div class="el-p"><p dir="auto">学过线程，我们可以用多个线程来处理多个I/O操作。如果线程被I/O阻塞了我们就重新创建一个线程。这确实是可行的，但是额外的线程就意为着多一份资源消耗和复杂性，滥用多线程可能并不是一个好的选择。况且有的语言并不支持多线程，如JavaScript，只有一个线程，我们别无选择。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.1.2 Synchronous I/O Multiplexing" dir="auto" class="heading" id="1.1.2_Synchronous_I/O_Multiplexing"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1.2 Synchronous I/O Multiplexing</h4><div class="heading-children"><div class="el-p"><p dir="auto">在大多数情况下，我们都希望使用一个线程来处理数个 I/O 请求。在学习真正的异步 I/O 之前，我们来学习一下同步 I/O 复用。还是公交车的例子，同步 I/O 复用就相当于是等公交车的时候每隔一段时间抬头看一看车到没到。但抬头的这段时间就会影响到玩手机的时间。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.2 select: An Old Synchronous I/O Multiplexing API" dir="auto" class="heading" id="1.2_select:_An_Old_Synchronous_I/O_Multiplexing_API"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2 select: An Old Synchronous I/O Multiplexing API</h3><div class="heading-children"><div class="el-p"><p dir="auto">select 是一个有些过时的同步 I/O 复用 API，在大多数系统上都广泛支持。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.1 Blocking I/O Operations" dir="auto" class="heading" id="1.2.1_Blocking_I/O_Operations"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.1 Blocking I/O Operations</h4><div class="heading-children"><div class="el-p"><p dir="auto">不是所有的I/O操作都能够异步完成，在文件系统的章节中，我们会学到<code>read()</code>系统调用。<code>read()</code>就是一个阻塞的 I/O 操作，意味着当程序调用 <code>read()</code> 时，它会等待数据被读取到内存buffer后才继续执行后续的代码，当遇到阻塞的I/O操作，你只能同步等待I/O操作完成。</p></div><div class="el-p"><p dir="auto">虽然我们还学到了许多 flags ，比如 <code>O_NONBLOCK</code> 的文件flag选项，也就是说用非阻塞的方式打开文件。但当设置文件的操作是<code>O_NONBLOCK</code>后，<code>read()</code>可能仍然会阻塞当前的线程。为什么？</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span> <span class="token comment">// For open(), O_RDONLY, O_WRONLY, O_RDWR, and file access modes</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token comment">// For close(), read(), write(), fsync(), lseek(), and others.</span></span>

<span class="token comment">// Non-blocking file read. It still blocks, not what we expected.</span>

<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> bytes_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> numbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Do something here.</span>
<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">我们所想的是使用<code>read()</code> 时，无论数据是否被放到缓冲区里，<code>read()</code>系统调用都应当立即返回一个返回值。但其实只有当使用 <code>O_NONBLOCK</code> 标志打开文件且没有数据可读，<code>read()</code> 调用才会立即返回。然而，对于磁盘文件，数据通常是立即可用的，因为内核会通过页缓存把数据从磁盘缓存到内存中，这个过程仍然会阻塞。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.2 Non-Blocking Sockets" dir="auto" class="heading" id="1.2.2_Non-Blocking_Sockets"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.2 Non-Blocking Sockets</h4><div class="heading-children"><div class="el-p"><p dir="auto">不同于读文件的确定性，对于 socket 或者 pipe 这类特殊文件，系统也不能确定 socket 什么时候能有数据，数据的大小是多少，这时 <code>O_NONBLOCK</code> 通常是可行的。</p></div><div class="el-p"><p dir="auto">既然对文件的读取不会再阻塞了，我们是否可以每隔一段时间就轮询一遍，这样就可以实现在一个线程里面同步复用多个 I/O 了。这确实是可行的。实际上，select 使用的就是类似的机制。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fcntl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">当设置非阻塞套接字后，<code>accept()</code>, <code>recv()</code> 和 <code>recvfrom()</code>都将是非阻塞的。这些系统调用将返回 <code>-1</code> 并设置 <code>errno</code> 为 <code>EAGAIN</code> 或 <code>EWOULDBLOCK</code>。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.3 Tight Poll" dir="auto" class="heading" id="1.2.3_Tight_Poll"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.3 Tight Poll</h4><div class="heading-children"><div class="el-p"><p dir="auto">那设置 non-blocking 的 sockets 有什么用处？我们的服务器总是要服务许多的客户端，假设每个客户端对应一个 socket 连接，那么服务器就需要响应监听这么多的 socket 连接。而这些网络相关的系统调用往往是阻塞的，我们并不想使用多线程来监听这些连接。</p></div><div class="el-p"><p dir="auto">通过设置非阻塞 socket，我们就不用被 socket 相关的系统调用所阻塞。进而，我们可以在主线程中轮询监听这些 sockets，也就是紧轮询。只在检测到客户端的连接时创建线程来响应服务客户端，免去浪费线程资源来处理无意义的 IO 阻塞。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.4 Now You Select" dir="auto" class="heading" id="1.2.4_Now_You_Select"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.4 Now You Select</h4><div class="heading-children"><div class="el-p"><p dir="auto">Tight polling(轮询)我们在<a data-tooltip-position="top" aria-label="13. IO Subsystem > 1.3.1 Tight Polling" data-href="13. IO Subsystem#1.3.1 Tight Polling" href="congzhi's-os-series/13.-io-subsystem.html#1.3.1_Tight_Polling" class="internal-link" target="_self" rel="noopener nofollow">IO 阶段</a>中了解过。我们了解了 tight polling 会不停的循环问询浪费CPU资源，尽管简单，但是无法避免地 CPU 做无用功。所以我们并不想这么做。</p></div><div class="el-p"><p dir="auto">内核为我们提供了一种更好的办法：select。select 使得我们可以设置一个监视器来监视一组的套接字，并告诉我们组中每个套接字的状态。socket状态可以是待读、待写和发生异常情况三种状态。<code>select()</code>会根据socket的状态将sockets放到可读、可写和一些异常的三种集合中进行管理。</p></div><div class="el-p"><p dir="auto">下面是<code>select()</code>系统调用的函数原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span> <span class="token comment">// For select() and related macros</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span>   <span class="token comment">// For struct timeval</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  <span class="token comment">// For data types used in some system calls</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span>     <span class="token comment">// For close(), read(), and other unix system calls</span></span>

<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span> <span class="token keyword">int</span> nfds<span class="token punctuation">,</span> 
		    fd_set <span class="token operator">*</span>_Nullable restrict readfds<span class="token punctuation">,</span>
            fd_set <span class="token operator">*</span>_Nullable restrict writefds<span class="token punctuation">,</span>
            fd_set <span class="token operator">*</span>_Nullable restrict exceptfds<span class="token punctuation">,</span>
            <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>_Nullable restrict timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. nfds: The highest-numbered file descriptor in any of the three sets, plus 1.
2. readfds: Pointer to an fd_set that will be checked for readability.
3. writefds: Pointer to an fd_set that will be checked for writability.
4. exceptfds: Pointer to an fd_set that will be checked for exceptional conditions.
5. timeout: Pointer to a struct timeval that specifies the maximum interval to wait for any file descriptor to become ready. If NULL, select() will block indefinitely.

Return value: 
- On success, returns the number of file descriptors contained in the three returned descriptor sets (that is, the total number of bits that are set in readfds, writefds, and exceptfds).
- On error, returns -1 and sets errno to indicate the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.4.1 `nfds`" dir="auto" class="heading" id="1.2.4.1_`nfds`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.4.1 <code>nfds</code></h5><div class="heading-children"><div class="el-p"><p dir="auto">我们来看第一个参数，<code>nfds</code> 是要监视文件描述符集合中最大文件描述符的值加 1。它用于告诉 <code>select()</code> 要检查的文件描述符的范围。具体来说，<code>select()</code> 会监控文件描述符从 0 到 <code>nfds</code> - 1 的文件描述符，等待一个或多个文件描述符变为"ready"状态。</p></div><div class="el-p"><p dir="auto">在许多老系统中，将进程打开文件表表项的最大数量设置为 1024 ，也就是每个进程最多可以打开的文件数。因此，<code>select()</code> 的监视集合 <code>fd_set</code> 能够最多监视 1024 个文件描述符。<code>fd_set</code> 是用固定大小的位图 bit field (bit array) 来实现的，每个文件描述符对应一个 bit。</p></div><div class="el-p"><p dir="auto">通过设置 <code>nfds</code>，在 <code>select()</code> 遍历时，内核遍历到最大的监视项后就会立即停止遍历。现在很多系统中，一个进程可能需要打开的文件数量可能要比 1024 个大得多。而 <code>select()</code> 最多也只能监视 1024 个文件描述符，这也是 <code>select()</code> 的缺点。在<a data-tooltip-position="top" aria-label="https://www.man7.org/linux/man-pages/man2/select.2.html" rel="noopener nofollow" class="external-link" href="https://www.man7.org/linux/man-pages/man2/select.2.html" target="_blank">select Linux manual</a>中，也推荐使用<a data-tooltip-position="top" aria-label="16. Asynchronous IO > 1.4 Alternative Poll" data-href="16. Asynchronous IO#1.4 Alternative Poll" href="congzhi's-os-series/16.-asynchronous-io.html#1.4_Alternative_Poll" class="internal-link" target="_self" rel="noopener nofollow">poll</a>或<a data-tooltip-position="top" aria-label="16. Asynchronous IO > 1.5 epoll I/O Event Notification Facility" data-href="16. Asynchronous IO#1.5 epoll I/O Event Notification Facility" href="congzhi's-os-series/16.-asynchronous-io.html#1.5_epoll_I/O_Event_Notification_Facility" class="internal-link" target="_self" rel="noopener nofollow">epoll</a>来获取更大的文件句柄监视范围。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.4.2 File Descriptor Sets" dir="auto" class="heading" id="1.2.4.2_File_Descriptor_Sets"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.4.2 File Descriptor Sets</h5><div class="heading-children"><div class="el-p"><p dir="auto">我们用<code>fd_set</code>结构来定义监视类型的结构：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>

fd_set readfds<span class="token punctuation">;</span>
fd_set writefds<span class="token punctuation">;</span>
fd_set exceptfds<span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>fd_set</code> 用于表示一个文件描述符的集合。在 POSIX 下，<code>fd_set</code>最多能够容纳的文件描述符的数量在 <code>FD_SETSIZE</code> 宏中定义，我们前面提到了，这个数字在很多系统中都是 1024，可能不会改变。所以通常而言，<code>fd_set</code> 数据结构都是一个大小为 1024 字节的位图。</p></div><div class="el-p"><p dir="auto"><code>select()</code>提供了一些设置<code>fd_set</code>的函数，如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span> <span class="token comment">// For select() and related macros</span></span>

<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. set: Pointer to an fd_set structure that will be initialized to have zero bits set, meaning no file descriptors are part of the set.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>FD_ZERO(fd_set *set)</code>用于初始化或清除一个<code>fd_set</code>结构，将其所有位清零，表示集合中没有任何文件描述符。由于 <code>select</code> 要循环地检查这些文件描述符，当要复用文件描述符时，你要重新进行初始化这些集合。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. fd: The file descriptor to be added to the set.
2. set: Pointer to an fd_set structure where the file descriptor will be added.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>FD_SET(int fd, fd_set *set)</code>用于将一个文件描述符添加到 <code>fd_set</code> 结构中。它会设置相应的位，表示该文件描述符现在是集合的一部分。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. fd: The file descriptor to be removed from the set.
2. set: Pointer to an fd_set structure from which the file descriptor will be removed.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>FD_CLR(int fd, fd_set *set)</code>用于从 <code>fd_set</code> 结构中移除一个文件描述符。它会清除相应的 bit 位，表示该文件描述符不再是集合的一部分。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. fd: The file descriptor to be checked.
2. set: Pointer to an fd_set structure that will be checked to see if the file descriptor is part of the set.

Return value:
- Returns a non-zero value if the file descriptor is part of the set, otherwise returns 0.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>FD_ISSET(int fd, fd_set *set)</code>用于检查一个文件描述符是否在 <code>fd_set</code> 结构中。如果该文件描述符在集合中，则返回非零值，否则返回 0。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.4.3 Select: The Three Easy Pieces" dir="auto" class="heading" id="1.2.4.3_Select:_The_Three_Easy_Pieces"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.4.3 Select: The Three Easy Pieces</h5><div class="heading-children"><div class="el-p"><p dir="auto"><code>select</code>会将文件描述符归为三类，分别是可读(<code>readfds</code>)、可写(<code>writefds</code>)和异常(<code>excaptfds</code>)。这三类参数是可选的，当你不需要某一类时，你可以将那个参数设置为<code>NULL</code>。这三个参数也是select 最重要的参数。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.4.4 The Timeout" dir="auto" class="heading" id="1.2.4.4_The_Timeout"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.4.4 The Timeout</h5><div class="heading-children"><div class="el-p"><p dir="auto">最后一个参数是<code>timeval</code>，这是一个结构体，用于指定 <code>select()</code> 等待文件描述符变为就绪的最大时间间隔。在这个等待时间内，select 会阻塞直到：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">一个文件描述符准备好了；</li>
<li data-line="1" dir="auto">被信号所中断；</li>
<li data-line="2" dir="auto">时间到了。</li>
</ol></div><div class="el-p"><p dir="auto"><code>timeval</code>结构体的定义如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> tv_sec<span class="token punctuation">;</span>    <span class="token comment">/* seconds */</span>
    <span class="token keyword">long</span> tv_usec<span class="token punctuation">;</span>   <span class="token comment">/* microseconds */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">当你将两个字段都设置为0，<code>select()</code>就会立刻返回。要是sockets中有数据可读，<code>select()</code>就会告诉你，不然就会告诉你监视的fds都没有准备好呢。如果<code>timeval</code>为 <code>NULL</code> ，<code>select()</code> 将无限期地阻塞，直到至少有一个文件描述符变为就绪。</p></div><div class="el-p"><p dir="auto">再用等公交车的例子说明一下，设置 <code>timeval</code> 的作用就是控制你抬头看公交车到没到的时间。在抬头的这段时间里，你实际上是被硬控阻塞的。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.5 The Changing is Painful" dir="auto" class="heading" id="1.2.5_The_Changing_is_Painful"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.5 The Changing is Painful</h4><div class="heading-children"><div class="el-p"><p dir="auto">无论因为何种原因导致<code>select()</code>的返回，除了 <code>nfds</code> 之外的一些参数可能会被更新。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.5.1 FD_SETS" dir="auto" class="heading" id="1.2.5.1_FD_SETS"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.5.1 FD_SETS</h5><div class="heading-children"><div class="el-p"><p dir="auto">当我们调用 <code>select()</code> 时，传入的文件描述符集合（<code>readfds</code>、<code>writefds</code> 和 <code>exceptfds</code>）会被内核修改，以反映哪些文件描述符在调用期间变为就绪状态。这是因为 <code>select()</code> 需要告诉你哪些文件描述符可以进行I/O操作，而不会阻塞。</p></div><div class="el-p"><p dir="auto">例如，你传入一个包含多个文件描述符的 <code>readfds</code> 集合，<code>select()</code> 会在返回时修改这个集合，只保留那些在调用期间变为可读的文件描述符。这样，你可以通过检查返回的集合来确定哪些文件描述符可以进行读取操作。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.5.2 Time Value" dir="auto" class="heading" id="1.2.5.2_Time_Value"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.5.2 Time Value</h5><div class="heading-children"><div class="el-p"><p dir="auto">如果在调用 <code>select()</code> 时传入了 <code>timeval</code> 结构体，内核可能（不）会修改这个结构体，以反映在调用期间实际经过的时间。如果你设置了一个 5 秒的超时时间，但 <code>select()</code> 在 2 秒后返回，有的操作系统内核实现可能会将 <code>timeval</code> 结构体中的剩余时间更新为 3 秒；而有些系统则会保留原先 5 秒的超时。因此，重新使用 <code>timeval</code> 结构体是不安全的，应该在每次调用 <code>select()</code> 前重新设置。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.6 Check the Returned Ones" dir="auto" class="heading" id="1.2.6_Check_the_Returned_Ones"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.6 Check the Returned Ones</h4><div class="heading-children"><div class="el-p"><p dir="auto">当<code>select()</code>返回时，它会将哪些可以直接进行的I/O操作保留在fd_sets里。要知道有哪些 I/O 操作，我们就需要迭代遍历检查我们之前添加过的所有文件描述符。这时，<code>FD_ISSET</code> 宏的作用就显现出来了。</p></div><div class="el-p"><p dir="auto">因为 <code>select()</code> 调用会修改传入的参数，以反映哪些文件描述符已经准备好进行 I/O 操作，以及实际经过的时间。所以在处理完成一轮的 <code>select()</code> 调用之后，我们需要重新设置 <code>fd_sets</code>、<code>timeval</code> 甚至 <code>nfds</code>。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.7 Socket Server" dir="auto" class="heading" id="1.2.7_Socket_Server"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.7 Socket Server</h4><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token function">listen_for_connections</span><span class="token punctuation">(</span><span class="token keyword">int</span> client_sock1<span class="token punctuation">,</span> <span class="token keyword">int</span> client_sock2<span class="token punctuation">,</span> <span class="token keyword">int</span> client_sock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> nfds <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span>  <span class="token punctuation">(</span>client_sock1 <span class="token operator">&gt;</span> client_sock2 
	                <span class="token operator">?</span>
	                <span class="token punctuation">(</span>client_sock1 <span class="token operator">&gt;</span> client_sock3 <span class="token operator">?</span> client_sock1 <span class="token operator">:</span> client_sock3<span class="token punctuation">)</span>
	                <span class="token operator">:</span> 
	                <span class="token punctuation">(</span>client_sock2 <span class="token operator">&gt;</span> client_sock3 <span class="token operator">?</span> client_sock2 <span class="token operator">:</span> client_sock3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	fd_set s<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
	<span class="token function">ptintf</span><span class="token punctuation">(</span><span class="token string">"Startup complete!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>quit<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">FD_SET</span><span class="token punctuation">(</span>service1_sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">FD_SET</span><span class="token punctuation">(</span>service2_sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">FD_SET</span><span class="token punctuation">(</span>service3_sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
		tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>nfds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// An Error occurred.</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"An error occurred in selest(): %s.\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			quit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Still waiting events...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>service1_sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">service1_activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>service2_sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">service2_activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>service3_sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">service3_activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">从上面的代码中，你实际上可以感受到 <code>select</code> 有多么低效。比如我们的进程打开了 560 个文件，但是只需要监视 550、540、539 号文件，这时，你传入的 <code>nfds</code> 是 551 （0号文件到550号文件共551个文件） 。猜猜 <code>select</code> 会帮你做什么？每次调用 <code>select()</code> 时，它都会遍历进程打开文件表中从 <code>0</code> 到 <code>nfds-1</code> 的文件描述符。即便其他 548 个描述符完全无关。</p></div><div class="el-p"><p dir="auto">而且，如果文件打开超过 1024 个文件，那就完蛋了。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.3 pselect" dir="auto" class="heading" id="1.3_pselect"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3 pselect</h3><div class="heading-children"><div class="el-p"><p dir="auto">除了<code>select()</code>，我们还有一个<code>pselect()</code>函数。<code>pselect()</code>的最后两个参数与<code>select()</code>有所不同。用于定义时间间隔的结构体<code>timespec</code>是一个<code>const</code>类型的参数，<code>pselect()</code>保证不对这个结构体的任何改变。另一个大的改变就是<code>sigmask</code>参数，用于定义哪些信号在等待期间被屏蔽。</p></div><div class="el-p"><p dir="auto"><code>pselect()</code>的函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span> <span class="token comment">// For select() and related macros</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span>   <span class="token comment">// For struct timeval</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  <span class="token comment">// For data types used in some system calls</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span>     <span class="token comment">// For close(), read(), write(), and other system calls</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span>     <span class="token comment">// For sigset_t and related functions</span></span>

<span class="token keyword">int</span> <span class="token function">pselect</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> 
			fd_set <span class="token operator">*</span>_Nullable restrict readfds<span class="token punctuation">,</span>
            fd_set <span class="token operator">*</span>_Nullable restrict writefds<span class="token punctuation">,</span>
            fd_set <span class="token operator">*</span>_Nullable restrict exceptfds<span class="token punctuation">,</span>
            <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>_Nullable restrict timeout<span class="token punctuation">,</span>
            <span class="token keyword">const</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>_Nullable restrict sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. nfds: The highest-numbered file descriptor in any of the three sets, plus 1.
2. readfds: Pointer to an fd_set that will be checked for readability.
3. writefds: Pointer to an fd_set that will be checked for writability.
4. exceptfds: Pointer to an fd_set that will be checked for exceptional conditions.
5. timeout: Pointer to a struct timespec that specifies the maximum interval to wait for any file descriptor to become ready. If NULL, pselect() will block indefinitely.
6. sigmask: Pointer to a sigset_t that specifies the signal mask to be used during the wait. If NULL, the signal mask is not changed.

Return value: 
- On success, returns the number of file descriptors contained in the three returned descriptor sets (that is, the total number of bits that are set in readfds, writefds, and exceptfds).
- On error, returns -1 and sets errno to indicate the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.3.1 timespec" dir="auto" class="heading" id="1.3.1_timespec"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.1 timespec</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>pselect()</code>中的<code>timespec</code>结构体容许我们设置更精细的时间间隔，它的结构体原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">timespec</span><span class="token punctuation">{</span>
	<span class="token keyword">long</span> tv_sec<span class="token punctuation">;</span> <span class="token comment">/* seconds */</span>
	<span class="token keyword">long</span> tv_nsec<span class="token punctuation">;</span> <span class="token comment">/* nanoseconds */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.3.2 sigmask" dir="auto" class="heading" id="1.3.2_sigmask"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2 sigmask</h4><div class="heading-children"><div class="el-p"><p dir="auto">允许你在调用<code>pselect()</code>的同时原子化地修改signal mask。在这个并发的世界中，我们对原子化的爱是毋庸置疑的。下面的一条<code>pselect()</code>语句：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">ready <span class="token operator">=</span> <span class="token function">pselect</span><span class="token punctuation">(</span>nfds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>writefds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exceptfds<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">和原子化的</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token class-name">sigset_t</span> origmask<span class="token punctuation">;</span>
<span class="token function">pthread_sigmask</span><span class="token punctuation">(</span>SIG_SETMASK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sigmask<span class="token punctuation">,</span> <span class="token operator">&amp;</span>origmask<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Mask the signals in sigmask.</span>
ready <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>nfds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>writefds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exceptfds<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_sigmask</span><span class="token punctuation">(</span>SIG_SETMASK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>origmask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Back to origmask stage.</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">是等价的。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.4 Poll: An Alternative Select" dir="auto" class="heading" id="1.4_Poll:_An_Alternative_Select"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4 Poll: An Alternative Select</h3><div class="heading-children"><div class="el-p"><p dir="auto">另一个与 select 相近的 API 叫<code>poll()</code>，它也是一种同步 IO 复用的 API 。相比于<code>select()</code>，<code>poll()</code>要求的参数更少。现在，你不再需要计算最大的<code>nfds</code>是多少了，也不用再提供三种集合了。但由于它们实现上的相近，作为<code>select()</code>的表亲，并没有带来性能上的加成，它们都很慢。</p></div><div class="el-p"><p dir="auto"><code>poll()</code>的函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span> <span class="token comment">// glibc library for poll() and related macros</span></span>

<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. fds: Pointer to an array of struct pollfd, which specifies the file descriptors to be monitored.
2. nfds: The number of items in the fds array.
3. timeout: The maximum number of milliseconds that poll() will block. A negative value means an infinite timeout, while zero means poll() will return immediately.

Return value: 
- On success, returns the number of file descriptors with events, which may be zero if the timeout expired.
- On error, returns -1 and sets errno to indicate the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.4.1 Poll File Descriptor" dir="auto" class="heading" id="1.4.1_Poll_File_Descriptor"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4.1 Poll File Descriptor</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>poll()</code>将所有的监视项都放在了一个<code>pollfd</code>结构体类型的数组中。在使用时，你还需要提供数组的项数（你想让它监视多少项），这比<code>select()</code>方便了不少。你想指定的事件需要在<code>pollfd</code>结构体中说明，这个结构体的原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">pollfd</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>         <span class="token comment">/* file descriptor */</span>
    <span class="token keyword">short</span> events<span class="token punctuation">;</span>   <span class="token comment">/* requested events */</span>
    <span class="token keyword">short</span> revents<span class="token punctuation">;</span>  <span class="token comment">/* returned events */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
events/revents:
- POLLIN: Look for if there is data to read.
- POLLOUT: Writing is now possible without blocking.
- POLLRDHUP: Stream socket peer closed connection, or shut down writing half of connection.
- POLLPRI: There is urgent data to read.

revents specific(be ignored in events):
- POLLERR: Error condition.
- POLLHUP: Hang up, otherside closed socket.
- POLLNVAL: Invalid request: fd not open.

compiling with _XOPEN_SOURCE(additional bits):
- POLLRDNORM: equivalent to POLLIN
- POLLRDBAND
- POLLWRNORM
- POLLWRBAND
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>fd</code>表示要监视的文件描述符。<code>events</code>是一个bit mask用于指定要监视何种事件，这是一个输入变量。<code>revents</code>是内核所设置的return events，用于标识当<code>poll()</code> 返回时，实际发生的事件。如果<code>fd</code>是一个负值，那么字段<code>events</code>就会被忽略，而且<code>revents</code>会返回<code>0</code>值。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.4.2 ERRNOs" dir="auto" class="heading" id="1.4.2_ERRNOs"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4.2 ERRNOs</h4><div class="heading-children"></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.4.4 3-Service Example with `poll()`" dir="auto" class="heading" id="1.4.4_3-Service_Example_with_`poll()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4.4 3-Service Example with <code>poll()</code></h4><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token function">listen_for_connections</span><span class="token punctuation">(</span><span class="token keyword">int</span> client_sock1<span class="token punctuation">,</span> <span class="token keyword">int</span> client_sock2<span class="token punctuation">,</span> <span class="token keyword">int</span> client_sock3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pollfds<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	pollfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> client_sock1<span class="token punctuation">;</span>
	pollfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
	pollfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> client_sock2<span class="token punctuation">;</span>
	pollfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
	pollfds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> client_sock3<span class="token punctuation">;</span>
	pollfds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
	<span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">"Going to start listening for socket events.\n"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>quit<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pollfds<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Error checking.</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			printf
			quit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 0 sockets had events occur</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Still waiting for events...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// things happened</span>
		<span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>pollfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">service0_activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>pollfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">service1_activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>pollfds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">service2_activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>						
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.5 ppoll" dir="auto" class="heading" id="1.5_ppoll"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.5 ppoll</h3><div class="heading-children"><div class="el-p"><p dir="auto">poll和ppoll的关系就如同select和pselect一样。同pselect一样，ppoll允许应用safely wait直到其中一个文件描述符准备好了或者有信号被捕获。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span>         <span class="token comment">/* See feature_test_macros(7) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">ppoll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span>
		  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>_Nullable tmo_p<span class="token punctuation">,</span>
          <span class="token keyword">const</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>_Nullable sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.6 epoll: I/O Event Notification Facility" dir="auto" class="heading" id="1.6_epoll:_I/O_Event_Notification_Facility"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6 epoll: I/O Event Notification Facility</h3><div class="heading-children"><div class="el-p"><p dir="auto"><code>epoll()</code>是一个 Linux-specific API，功能和<code>poll()</code>差不多，都通过监视一组文件描述符来看 I/O 是否可用。但 epoll API 和 poll 却有本质上的区别。epoll API 提供了边沿触发和电平触发两种使用接口。在高并发情境下，epoll API 的性能要好得多。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.6.1 epoll Instance" dir="auto" class="heading" id="1.6.1_epoll_Instance"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6.1 epoll Instance</h4><div class="heading-children"><div class="el-p"><p dir="auto">epoll instance 是 epoll API 中最重要的概念。epoll instance 是一个内核数据结构。在用户程序眼中，他就是一个包含两个列表的容器。这两个列表是兴趣列表 (interest list) 和就绪列表 (ready list)。从名字中你就能大致知道这两个列表的作用。</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">
<p><strong>Interest list</strong> 也叫 epoll set，是一个包含一些文件描述符的集合。在 interest list 中的文件描述符是用户进程所感兴趣的一些监视项。通过将这些感兴趣的文件描述符添加到 interest list 中，我们就能用 epoll API 让操作系统帮我们监视这些文件描述符的状态。（红黑树）</p>
</li>
<li data-line="2" dir="auto">
<p><strong>Ready list</strong> 是第二个列表。这个列表包含了那些准备好了进行 I/O 操作的文件描述符，ready list 是 interest list 的一个子集。一旦 interest list 中的文件描述符有 I/O 活动，内核就会动态地把相应的文件描述符添加到 ready list 中。（双向链表）</p>
</li>
</ul></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.6.2 Why's epoll This Darn Fast" dir="auto" class="heading" id="1.6.2_Why's_epoll_This_Darn_Fast"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6.2 Why's epoll This Darn Fast</h4><div class="heading-children"><div class="el-p"><p dir="auto">为什么 epoll 这么快呢？我们得从 epoll instance 开始谈起。 epoll instance 中维护两个 "list" ，其中，interest list 是我们想让 epoll 帮我们监视的文件描述符集合，这是一个红黑树。而红黑树使得 epoll 在插入、删除、查找文件描述符的时间复杂度均为 <span class="math math-inline is-loaded"><mjx-container class="MathJax" jax="CHTML"><mjx-math class="MJX-TEX"><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D442 TEX-I"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c class="mjx-c28"></mjx-c></mjx-mo><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D459 TEX-I"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D45C TEX-I"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D454 TEX-I"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D45B TEX-I"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c class="mjx-c29"></mjx-c></mjx-mo></mjx-math></mjx-container></span> ，适合管理大量的文件描述符。</p></div><div class="el-p"><p dir="auto">此外，我们前面学习的 select 和 poll 模型需要不断地遍历所有监听的文件描述符（时间复杂度 <span class="math math-inline is-loaded"><mjx-container class="MathJax" jax="CHTML"><mjx-math class="MJX-TEX"><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D442 TEX-I"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c class="mjx-c28"></mjx-c></mjx-mo><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D45B TEX-I"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c class="mjx-c29"></mjx-c></mjx-mo></mjx-math></mjx-container></span> ），而 epoll 会通过回调机制仅仅跟踪活跃的文件描述符。调用 <code>epoll_wait</code> 时直接返回就绪的文件描述符（时间复杂度 <span class="math math-inline is-loaded"><mjx-container class="MathJax" jax="CHTML"><mjx-math class="MJX-TEX"><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D442 TEX-I"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c class="mjx-c28"></mjx-c></mjx-mo><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c></mjx-mn><mjx-mo class="mjx-n"><mjx-c class="mjx-c29"></mjx-c></mjx-mo></mjx-math></mjx-container></span>），性能并不会随监听的文件描述符数量增长而下降。</p></div><div class="el-p"><p dir="auto">epoll 使用回调机制就是当某个文件描述符（如 socket）发生 I/O 事件（如可读、可写）时，内核会主动通知 epoll，而不是由 epoll 主动轮询检查所有 fd。和 select/poll 那样时不时地看一眼公交车有没有到相比，让司机通知你肯定更好一些。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.6.3 Create and Manage an epoll Instance" dir="auto" class="heading" id="1.6.3_Create_and_Manage_an_epoll_Instance"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6.3 Create and Manage an epoll Instance</h4><div class="heading-children"><div class="el-p"><p dir="auto">现在，我们先了解了解用来创建和管理 epoll instances 的系统调用。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="epoll Instance Creation: `epoll_create` and `epoll_create1`" dir="auto" class="heading" id="epoll_Instance_Creation:_`epoll_create`_and_`epoll_create1`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>epoll Instance Creation: <code>epoll_create</code> and <code>epoll_create1</code></h5><div class="heading-children"><div class="el-p"><p dir="auto">要创建一个 epoll instance，我们有两种方式：<code>epoll_create</code> 和 <code>epoll_create1</code>。<code>epoll_create</code> 会创建一个 epoll instance。在 Linux 2.6.8 之后，内核会动态地检查 epoll instance，所以这个系统调用参数 <code>size</code> 会被忽略，但为了兼容新版本，<code>size</code> 必须比 0 大。</p></div><div class="el-p"><p dir="auto">它的系统调用原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Parameters:

1. size: initial size (ignored in modern implementations, but must be &gt; 0)

Returns a file descriptor for the new epoll instance, or -1 on error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">在 Linux 2.6.27 后，内核提供了另一种创建 epoll instance 的系统调用。我们不再需要担心 <code>size</code> 是否大于 0 的问题了，而且还引入了 flags 参数。flags 可以是 0 或 <code>EPOLL_CLOEXEC</code>，用于在执行 <code>exec</code> 系列函数时自动关闭 epoll 文件描述符。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// create a new epoll instance with flags</span>
<span class="token comment">/* Parameters:

1. flags: epoll instance flags (0 or EPOLL_CLOEXEC)

Returns a file descriptor for the new epoll instance, or -1 on error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">当不再需要这些文件描述符后，记得用 <code>close()</code> 系统调用关闭掉相关的文件描述符。epoll 使用引用计数来管理 instance 的生命周期，当 epoll instance 中的所有文件描述符都关闭后，内核就会销毁 instance 并释放相关联的资源。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="epoll Instance Control" dir="auto" class="heading" id="epoll_Instance_Control"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>epoll Instance Control</h5><div class="heading-children"><div class="el-p"><p dir="auto">在 epoll instance 创建好之后，我们就可以通过创建返回的 <code>epfd</code> 往 interest list 中添加、修改或删除 list entries（也就是文件描述符和 <code>event</code> 字段中特化的事件）。</p></div><div class="el-p"><p dir="auto">以下是 <code>epoll_ctl</code> 系统调用的原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">/* Parameters:

1. epfd: file descriptor returned by epoll_create or epoll_create1
2. op: operation to be performed 
	- EPOLL_CTL_ADD: Add an entry to the interest list of the epfd.
	- EPOLL_CTL_MOD: Change the settings associated with fd in the interest list
		             to the new settings specified in event.
	- EPOLL_CTL_DEL: Remove the target file descriptor fd from the interest list.
3. fd: file descriptor to be added, modified, or removed
4. event: pointer to epoll_event structure (can be NULL for EPOLL_CTL_DEL)

Returns 0 on success, or -1 on error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">除了我们刚才提到的 <code>epfd</code> 参数外，我们还有三个参数，分别是 <code>op</code>, <code>fd</code>, 和一个指针指向结构体 <code>epoll_event</code>。最开始的时候，epoll instance  为空，我们就需要在 <code>op</code> 上填入 <code>EPOLL_CTL_ADD</code> 来向 interest list 中添加相关的文件描述符，同时，在 <code>epoll_event</code> 结构体中选择让内核按何种方式来监视这些文件描述符。</p></div><div class="el-p"><p dir="auto"><code>op</code> 字段提供将某个文件描述符加入到 interest list 中进行监视、<code>fd</code> 字段指示监视项、<code>event</code> 主要是一些监视选项，它是 epoll 机制中用于事件监视和传递用户数据的核心结构体。 <code>struct epoll_event</code> 的原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span>      events<span class="token punctuation">;</span>  <span class="token comment">/* Epoll events */</span>
    <span class="token class-name">epoll_data_t</span>  data<span class="token punctuation">;</span>    <span class="token comment">/* User data variable */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
events/revents:
- EPOLLIN: Look for if there is data to read.
- EPOLLOUT: Writing is now possible without blocking.
- EPOLLRDHUP: Stream socket peer closed connection, or shut down writing half of connection.
- EPOLLPRI: There is urgent data to read.

revent specific:
- EPOLLERR: Error condition happened.
- EPOLLHUP: Hang up, otherside closed socket.
- EPOLLNVAL: Invalid request: fd not open.

additional epoll-specific flags:
- EPOLLET: Requests edge-triggered notification.
- EPOLLONESHOT: Requests one-shot notification.
- EPOLLWAKEUP: Prevent system suspend while event is pending.
- EPOLLEXCLUSIVE: Sets exclusive wakeup mode.
*/</span>
<span class="token keyword">union</span> epoll_data <span class="token punctuation">{</span>
    <span class="token keyword">void</span>     <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span>       fd<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span>  u32<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span>  u64<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">这里的联合体 <code>epoll_data</code> 是用户的自定义数据，当事件触发时，内核就会将此数据返回给应用。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.6.4 Waiting for I/O Events to Happen" dir="auto" class="heading" id="1.6.4_Waiting_for_I/O_Events_to_Happen"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6.4 Waiting for I/O Events to Happen</h4><div class="heading-children"><div class="el-p"><p dir="auto">在上面，我们了解到用户感兴趣的 instances 会被添加到兴趣列表中提供给 epoll 来监视，如果有事件发生，epoll 会将可用的文件描述符放到 ready list 中。epoll API 给我们提供了下面的函数来监视 I/O 事件发生：<code>epoll_wait</code>, <code>epoll_pwait</code> 和 <code>epoll_pwait2</code>。下面是这三个函数的原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token comment">/* Waits for events on an epoll file descriptor. */</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
Parameters:
1. epfd: The epoll file descriptor obtained from epoll_create or epoll_create1.
2. events: Pointer to an array of epoll_event structures where the ready events will be stored.
3. maxevents: The maximum number of events that can be returned (must be &gt; 0).
4. timeout: Timeout in milliseconds:
   - -1: Block indefinitely until an event occurs.
   - 0: Return immediately.
   - &gt; 0: Maximum wait time in milliseconds.

Return value:
- Returns the number of ready file descriptors.
- On failure, returns -1 and sets errno.
*/</span>

<span class="token comment">/* Waits for events with the ability to temporarily block signals. */</span>
<span class="token keyword">int</span> <span class="token function">epoll_pwait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">,</span>  
				<span class="token keyword">const</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>_Nullable sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
Parameters:
1. epfd, events, maxevents, timeout: Same as epoll_wait.
2. sigmask: Signal mask to be temporarily applied during the wait. Can be NULL to behave like epoll_wait.

Return value:
- Same as epoll_wait.
*/</span>

<span class="token comment">/* Waits for events with nanosecond-resolution timeout and signal mask support. */</span>
<span class="token keyword">int</span> <span class="token function">epoll_pwait2</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> 
				 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>_Nullable timeout<span class="token punctuation">,</span> 
				 <span class="token keyword">const</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>_Nullable sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
Parameters:
1. epfd, events, maxevents: Same as epoll_wait.
2. timeout: High-resolution timeout using timespec structure (supports nanosecond precision). NULL indicates indefinite blocking.
3. sigmask: Signal mask to be temporarily applied during the wait. Can be NULL to behave like epoll_wait.

Return value:
- Same as epoll_wait.
*/</span>

</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">我们以 <code>epoll_wait</code> 为例，解释一下每个字段的含义：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><code>epfd</code>：这是需要被监视的 epoll instance 。</li>
<li data-line="1" dir="auto"><code>events</code>：这是用户分配的 <code>epoll_event</code> 数组指针，用于接收就绪事件。</li>
<li data-line="2" dir="auto"><code>maxevents</code>：<code>events</code> 数组的最大容量（必须大于0）</li>
<li data-line="3" dir="auto"><code>timeout</code>：超时时间。<br>
如果是 -1 ，则阻塞线程，直到有事件发生；<br>
如果是 0，则立即返回（非阻塞模式）。<br>
如果 &gt; 0，那么 <code>epoll_wait</code> 就会阻塞这么长时间后返回（毫秒）。</li>
</ol></div><div class="el-p"><p dir="auto">你可能会好奇，epoll instance 中明明有一个 ready list，为什么还需要人为设置一个 <code>events</code> 数组？这时因为 ready list 是一个内核中的数据结构，我们在用户态是访问不到的，所以我们要提供一个存放文件描述符的数组，让内核在事件发生后将 ready list 中的 fd 拷贝到 <code>events</code> 数组中。拷贝完成后， ready list 将会被清空。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.6.5 Level-Triggered and Edge-Triggered Events" dir="auto" class="heading" id="1.6.5_Level-Triggered_and_Edge-Triggered_Events"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6.5 Level-Triggered and Edge-Triggered Events</h4><div class="heading-children"><div class="el-p"><p dir="auto">epoll 支持两种不同的触发方式：水平触发 (LT) 和边沿触发 (ET) 。下面，我们将用一个简单的例子来说明这两种不同的触发方式。</p></div><div class="el-p"><p dir="auto">假设我们现在通过一个 socket 来请求远方的数据，然后把接收方的文件描述符注册到一个 epoll instance 上。一旦我们调用 <code>epoll_wait</code>，线程就会被阻塞，直到操作系统通知线程有数据到达（通过回调）。假如到达 5M 数据，而我们只读取 3MB，buffer 中剩余 2MB。当我们读取完成后继续调用 <code>epoll_wait</code>，两种不同的触发方式会发生什么？</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="Level-Triggered" dir="auto" class="heading" id="Level-Triggered"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Level-Triggered</h5><div class="heading-children"><div class="el-p"><p dir="auto">水平触发是一种<strong>状态驱动</strong>的模式，也就是说只要文件描述符满足某种状态条件，<code>epoll_wait</code> 就会持续返回该 <code>fd</code> 的事件。这类似于水位报警器——只要水位高于警戒线，警报就会持续触发。</p></div><div class="el-p"><p dir="auto">如果缓冲区中有未读的滞留数据，那么再次调用的 <code>epoll_wait</code> 会立即返回。即使你没有发生方没有再发送数据。水平触发方式时 epoll 默认情况下的触发方式，适用于大多数应用场景。</p></div><div class="el-p"><p dir="auto">当 epoll 使用默认的 LT 时，他的行为就类似于 poll，只是 epoll 的速度会更快一些。所以在任何情况下的开发，你都应当优先考虑 epoll，因为思想上差不多的。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="Edge-Triggered" dir="auto" class="heading" id="Edge-Triggered"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Edge-Triggered</h5><div class="heading-children"><div class="el-p"><p dir="auto">边沿触发是一种<strong>事件驱动</strong>的模式，只在 <code>fd</code> 的状态发生变化时触发事件通知（如：<strong>从无数据到有数据</strong>）。如果没有新的数据到达，即使缓冲区仍然有数据，<code>epoll_wait()</code> 仍然会继续阻塞等待数据的到来（从“无”到”有“）。 </p></div><div class="el-p"><p dir="auto">关键在于，在 ET 模式下，线程必须持续读数据，直到 <code>read()</code> 或 <code>write()</code> 返回 <code>EAGAIN</code>（完全读完缓冲区），否则就可能错过滞留数据。又由于 ET 不会重复通知缓冲区的未读数据，因此它需要配合非阻塞 IO 使用，避免长时间不必要的阻塞。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="One Shot Mechanism" dir="auto" class="heading" id="One_Shot_Mechanism"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>One Shot Mechanism</h5><div class="heading-children"><div class="el-p"><p dir="auto">继续 socket 的例子，我们知道 TCP 的数据可能分片到达，这种分批次到达的情况对于 LT 而言可能轻松应对。然而对于 ET 来说，由于数据分批次，所以一个事件可能被多次触发。如果你不想让 <code>epoll_wait()</code> 反复处理该 fd，我们就可以启用 <code>EPOLLONESHOT</code> 标志。</p></div><div class="el-p"><p dir="auto">它的作用就是在事件触发时自动禁用该 fd 的后续通知，防止一个 fd 被 <code>epoll_wait</code> 反复触发。这个标志我们在前面的 <code>epoll_ctl</code> 中有提到。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="Thundering Herd" dir="auto" class="heading" id="Thundering_Herd"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Thundering Herd</h5><div class="heading-children"><div class="el-p"><p dir="auto">如果 fd 是 ET 模式被添加到了 epoll instance 中，那么在多个线程同时调用 <code>epoll_wait</code> 监听同一个 epoll instance 时，epoll 可以保证只有一个线程被唤醒。避免了”惊群效应“，即多个线程被同时唤醒，导致资源的浪费。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.6.6 System Auto Sleep" dir="auto" class="heading" id="1.6.6_System_Auto_Sleep"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6.6 System Auto Sleep</h4><div class="heading-children"><div class="el-p"><p dir="auto">在 Linux 系统中，<code>/sys/power/autosleep</code> 允许设备进入自动休眠模式以节省电力。当系统处于自动休眠模式时，某些事件的发生（网络数据到达，用户输入）会唤醒设备。但是设备仅仅维持该事件被加入到事件队列中，随后可能再次进入休眠状态。</p></div><div class="el-p"><p dir="auto">如果你希望设备在事件发生后一直保持唤醒，知道事件被处理完毕，那么就需要把 <code>EPOLLWAKEUP</code> 标志启用。这个标志在 <code>epoll_ctl</code> 中有提到。（如果希望设备在第二次 <code>epoll_wait</code> 之前保持唤醒，就需要使用额外的 wake_lock ）。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.6.7 Best Practice" dir="auto" class="heading" id="1.6.7_Best_Practice"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.6.7 Best Practice</h4><div class="heading-children"><div class="el-p"><p dir="auto">在 ET 模式下：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Non-Blocking Sockets</li>
<li data-line="1" dir="auto">Continuing Reading/Writing</li>
<li data-line="2" dir="auto">Recording States</li>
</ul></div></div></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第二课 cURL" dir="auto" class="heading" id="第二课_cURL"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第二课 cURL</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">第一节课的时候，我们学习了三个用于服务器上的异步I/O处理方式。本节课，我们来了解一些如何通过Client URL来处理网络客户端上的异步I/O。</p></div><div class="el-p"><p dir="auto">cURL 是对 socket 接口的封装，它是一个用户程序，可能需要你自己下载安装相关的开发包。随后，通过包含头文件 <code>curl/curl.h</code> 并链接 <code>-lcurl</code> ，你就能在你的程序中使用<code>libcurl</code>库来请求HTTP服务、下载文件和一些其他的网络服务。</p></div><div class="el-p"><p dir="auto">由于大多数的资源在服务器的手中，客户端想要某些资源就需要向服务器发送响应的请求。同样，当你使用 cURL 进行请求时，默认的 cURL API（<code>curl_easy_perform()</code>）会阻塞我们的程序。而通过上节课，我们知道，这种阻塞并不是我们想要的。我们想不浪费资源的同时提高程序的效率。</p></div><div class="el-p"><p dir="auto">幸运的是，<code>libcurl</code>库中有能够让我们同时handle多个异步IO的API。<code>curl_multi</code>允许客户端同时进行多个网络操作请求，而且不会阻塞用户程序。但再此之前，我们先来看看默认的 cURL API。</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.1 cURL Global" dir="auto" class="heading" id="2.1_cURL_Global"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1 cURL Global</h3><div class="heading-children"><div class="el-p"><p dir="auto">在使用这些<code>libcurl</code>的库函数之前，我们需要调用<code>curl_global_init()</code>进行全局初始化，并在程序结束时调用<code>curl_global_cleanup()</code>进行全局清理。</p></div><div class="el-p"><p dir="auto">下面是它们的函数原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;curl/curl.h&gt;</span></span>

CURLcode <span class="token function">curl_global_init</span><span class="token punctuation">(</span><span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Initializes the cURL library globally.
   Parameters:
   1. flags: Bitmask of options to initialize. Commonly used values include:
      - CURL_GLOBAL_DEFAULT: Initialize all supported features (equivalent to CURL_GLOBAL_SSL | CURL_GLOBAL_WIN32).
      - CURL_GLOBAL_SSL: Initialize SSL.
      - CURL_GLOBAL_WIN32: Initialize Windows-specific features.
      - CURL_GLOBAL_ALL: Equivalent to CURL_GLOBAL_DEFAULT.
      - CURL_GLOBAL_NOTHING: Initialize no features.
   Return value:
   - On success, returns CURLE_OK.
   - On failure, returns a CURLcode error value. Those error values include:
	   - CURLE_UNSUPPORTED_PROTOCOL
	   - CURLE_FAILED_INIT
	   - CURLE_URL_MALFORMAT
	   - CURLE_COULDNT_RESOLVE_HOST
	   - CURLE_COULDNT_CONNECT
	   - CURLE_OPERATION_TIMEDOUT
	   - CURLE_SSL_CONNECT_ERROR
	   - CURLE_PEER_FAILED_VERIFICATION
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>curl_global_init(long flags);</code>为我们提供了一些可选项。一般我们会使用在flags字段中填入<code>CURL_GLOBAL_DEFAULT</code>，表示初始化所有cURL支持的功能，它和<code>CURL_GLOBAL_ALL</code>是等价的。在初始化完成之后，用户会得到<code>CURLcode</code>类型的返回值，用于反馈操作结果。</p></div><div class="el-p"><p dir="auto">在程序结束或我们不再需要cURL库的服务时，我们就可以使用<code>curl_global_cleanup()</code>全局清理cURL库。这个函数不需要任何参数，也不会有返回值。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token function">curl_global_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Cleans up the cURL library globally.
   Parameters: None.
   Return value: None.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.2 cURL Easy Interface" dir="auto" class="heading" id="2.2_cURL_Easy_Interface"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2 cURL Easy Interface</h3><div class="heading-children"><div class="el-p"><p dir="auto"><code>libcurl</code>库为我们提供了一些库函数用于与cURL进行交互，这些函数使得我们可以方便地进行网络请求和数据传输。通过使用这些库函数，我们可以实现HTTP、HTTPS、FTP等多种协议的支持。在cURL Easy API Interface中，我们会使用cURL easy handle来获取cURL的服务。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.1 EZ Initialization and EZ Option Setting" dir="auto" class="heading" id="2.2.1_EZ_Initialization_and_EZ_Option_Setting"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1 EZ Initialization and EZ Option Setting</h4><div class="heading-children"><div class="el-p"><p dir="auto">在全局初始化完成之后，我们就可以获取cURL handle并设置相应的选项来获取cURL的服务。其中我们用<code>curl_easy_init()</code>初始化并获取一个cURL easy handle，用<code>curl_easy_setopt()</code>设置handle的属性。</p></div><div class="el-p"><p dir="auto">下面是这两个函数的原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURL <span class="token operator">*</span><span class="token function">curl_easy_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Initializes a CURL easy handle.
   Return value:
   - On success, returns a pointer to a CURL easy handle.
   - On failure, returns NULL.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>curl_easy_init()</code>并不需要什么参数，如果初始化成功完成，它会返回一个指向初始化handle的指针，如果失败，它会返回<code>NULL</code>。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLcode <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>CURL <span class="token operator">*</span>handle<span class="token punctuation">,</span> CURLoption option<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Sets options for a CURL easy handle.
   Parameters:
   1. handle: The CURL easy handle.
   2. option: The option to set. Common options include:
      - CURLOPT_URL: The URL to fetch.
      - CURLOPT_POSTFIELDS: The data to send in a POST request.
      - CURLOPT_HTTPHEADER: A linked list of HTTP headers to include in the request.
      - CURLOPT_WRITEFUNCTION: A callback function to handle data received from the server.
      - CURLOPT_WRITEDATA: A pointer to pass to the write callback function.
      - CURLOPT_READFUNCTION: A callback function to handle data sent to the server.
      - CURLOPT_READDATA: A pointer to pass to the read callback function.
      - CURLOPT_TIMEOUT: The maximum time in seconds that the request is allowed to take.
   3. ...: The value to set for the option, depends on the option being set.
   Return value:
   - On success, returns CURLE_OK.
   - On failure, returns a CURLcode error value.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>curl_easy_setopt()</code>要复杂的多。这个库函数会根据不同的设置项来配置&nbsp;cURL&nbsp;easy&nbsp;handle&nbsp;的行为。而且每个选项后面的参数类型会根据不同的选项而有所不同。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.2 Easy Perform" dir="auto" class="heading" id="2.2.2_Easy_Perform"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.2 Easy Perform</h4><div class="heading-children"><div class="el-p"><p dir="auto">所有的所有都完成之后，我们就可以使用<code>curl_easy_perform()</code>来执行请求了。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLcode <span class="token function">curl_easy_perform</span><span class="token punctuation">(</span>CURL <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Performs the file transfer.
   Parameters:
   1. handle: The CURL easy handle.
   Return value:
   - On success, returns CURLE_OK.
   - On failure, returns a CURLcode error value.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.3 EZ Cleanup" dir="auto" class="heading" id="2.2.3_EZ_Cleanup"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.3 EZ Cleanup</h4><div class="heading-children"><div class="el-p"><p dir="auto">完成请求后，我们使用<code>curl_easy_cleanup()</code>来清理handle。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token function">curl_easy_cleanup</span><span class="token punctuation">(</span>CURL <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Cleans up a CURL easy handle.
   Parameters:
   1. handle: The CURL easy handle to clean up.
   Return value: None.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.4 Error Checking" dir="auto" class="heading" id="2.2.4_Error_Checking"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.4 Error Checking</h4><div class="heading-children"><div class="el-p"><p dir="auto">在上面，我们看到好几个函数都会返回的<code>CURLcode</code>用于指示函数是否正常运行。我们可以通过库函数<code>curl_easy_strerror()</code>&nbsp;来查看具体的错误信息。这个函数会返回一个描述错误的字符串，帮助我们理解问题之所在。</p></div><div class="el-p"><p dir="auto">以下是&nbsp;<code>curl_easy_strerror()</code>&nbsp;的函数原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">curl_easy_strerror</span><span class="token punctuation">(</span>CURLcode errornum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Returns a string describing the CURLcode error.
   Parameters:
   1. errornum: The CURLcode error value.
   Return value:
   - Returns a pointer to a null-terminated string describing the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.5 An Example" dir="auto" class="heading" id="2.2.5_An_Example"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5 An Example</h4><div class="heading-children"><div class="el-p"><p dir="auto">在下面的例子中，我们通过设置 <code>curl_easy_setopt(curl, CURLOPT_URL, "https://congzhi.wiki/");</code> 来请求网站的 <code>index.html</code> 。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;curl/curl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>
    CURL <span class="token operator">*</span>curl<span class="token punctuation">;</span>
    CURLcode res<span class="token punctuation">;</span>

    <span class="token function">curl_global_init</span><span class="token punctuation">(</span>CURL_GLOBAL_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    curl <span class="token operator">=</span> <span class="token function">curl_easy_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curl<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>curl<span class="token punctuation">,</span> CURLOPT_URL<span class="token punctuation">,</span> <span class="token string">"https://congzhi.wiki/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token function">curl_easy_perform</span><span class="token punctuation">(</span>curl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">!=</span> CURLE_OK<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"curl_easy_perform() failed: %s\n"</span><span class="token punctuation">,</span>
				<span class="token function">curl_easy_strerror</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_easy_cleanup</span><span class="token punctuation">(</span>curl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">curl_easy_cleanup</span><span class="token punctuation">(</span>curl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_global_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">cURL easy 什么都好，但和其他请求 IO 的函数一样，<code>res = curl_easy_perform(curl);</code> 这一步会阻塞程序，这就是 easy perform 最大的缺点。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.3 cURL Multi: A Easy Manager" dir="auto" class="heading" id="2.3_cURL_Multi:_A_Easy_Manager"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3 cURL Multi: A Easy Manager</h3><div class="heading-children"><div class="el-p"><p dir="auto">为了确保一个线程能够操作多个异步I/O，<code>libcurl</code>库提供了 cURL&nbsp;multi&nbsp;API 。cURL&nbsp;multi 用于管理一组easy&nbsp;handles，通过将多个easy&nbsp;handles放到一个队列中，并检查它们的状态来实现异步I/O。我们将包含多个easy handles队列的这样一个结构叫做multi handle。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.1 cURL Multi Interface" dir="auto" class="heading" id="2.3.1_cURL_Multi_Interface"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.1 cURL Multi Interface</h4><div class="heading-children"><div class="el-p"><p dir="auto">因为 cURL multi 是在 cURL easy 的基础上建立起来的，所以在使用cURL multi时，我们仍然需要进行cURL全局上的初始化、清理等。此外，由于我们引入了新的结构，我们需要一个新的类型来表示multi handle。在<code>libcurl</code>中，这个结构叫<code>CURLM</code>。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.2 Multi-Init" dir="auto" class="heading" id="2.3.2_Multi-Init"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.2 Multi-Init</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>curl_multi</code>&nbsp;内部维护了两个队列，分别是正在进行的传输队列和已经完成的传输队列。当curl multi handle初始化完成后，两个队列也随之初始化。</p></div><div class="el-p"><p dir="auto">此外，<code>curl_multi_init</code> 还会初始化内部状态和数据结构、分配必要的资源和内存等。</p></div><div class="el-p"><p dir="auto">函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;curl/multi.h&gt;</span> <span class="token comment">// Included &lt;curl/curl.h&gt;</span></span>

CURLM <span class="token operator">*</span><span class="token function">curl_multi_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Initializes a CURL multi handle.
   Return value:
   - On success, returns a pointer to a CURL multi handle.
   - On failure, returns NULL.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.3 Add EZ Handle" dir="auto" class="heading" id="2.3.3_Add_EZ_Handle"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.3 Add EZ Handle</h4><div class="heading-children"><div class="el-p"><p dir="auto">我们有了新的结构后，我们可以往里面添加任意数量的 easy handle 。我们所添加的 easy handles 就会被放到正在进行的传输队列中。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLMcode <span class="token function">curl_multi_add_handle</span><span class="token punctuation">(</span>CURLM <span class="token operator">*</span>multi_handle<span class="token punctuation">,</span> CURL <span class="token operator">*</span>easy_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Adds a CURL easy handle to a CURL multi handle.
   Parameters:
   1. multi_handle: The CURL multi handle.
   2. easy_handle: The CURL easy handle to add.
   Return value:
   - On success, returns CURLM_OK.
   - On failure, returns a CURLMcode error value.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.4 Easy Handles Dispatch" dir="auto" class="heading" id="2.3.4_Easy_Handles_Dispatch"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.4 Easy Handles Dispatch</h4><div class="heading-children"><div class="el-p"><p dir="auto">在添加完需要添加的 easy handles 之后，我们就可以使用 <code>curl_multi_perform()</code> 来启动多个并发的网络请求（第一次使用），这个函数会立即返回正在进行传输队列中的 easy handles 的数量，所以这些请求不会阻塞当前程序。</p></div><div class="el-p"><p dir="auto">其函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLMcode <span class="token function">curl_multi_perform</span><span class="token punctuation">(</span>CURLM <span class="token operator">*</span>multi_handle<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>still_running_handles<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Performs the transfers for all added handles.
   Parameters:
   1. multi_handle: The CURL multi handle.
   2. still_running_handles: Pointer to an integer that will be set to the number of running handles.
   Return value:
   - On success, returns CURLM_OK.
   - On failure, returns a CURLMcode error value.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">启用后，当我们使用<code>curl_multi_perform()</code>时，它会更新参数<code>still_running_handles</code>用于指示multi handle中仍在进行传输的easy handles的数量。当这个参数指向的数字变成<code>0</code>，你就知道IO全部完成了。而这就意味着我们需要多次调用<code>curl_multi_perform()</code>，这是否意味着我们在轮询呢？</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.5 Maybe A Bit of Naps?" dir="auto" class="heading" id="2.3.5_Maybe_A_Bit_of_Naps?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.5 Maybe A Bit of Naps?</h4><div class="heading-children"><div class="el-p"><p dir="auto">尽管我们实现了在一个线程中处理多个IO，我们仍不希望无意义的轮询占用太多CPU时间。为了解决这个问题，<code>libcurl</code> 提供了 <code>curl_multi_wait()</code> 函数，它可以在有数据可读或可写之前阻塞一段时间，让紧轮询变成松轮询。</p></div><div class="el-p"><p dir="auto">下面是它的函数原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLMcode <span class="token function">curl_multi_wait</span><span class="token punctuation">(</span>CURLM <span class="token operator">*</span>multi_handle<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">curl_waitfd</span> extra_fds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
						  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> extra_nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout_ms<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>numfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Waits for activity on any of the curl easy handles within a multi handle.
   Parameters:
   1. multi_handle: The CURL multi handle.
   2. extra_fds: An array of extra fds to wait on.(NULL)
   3. extra_nfds: The number of extra file descriptors.(0)
   4. timeout_ms: The maximum time to wait in milliseconds.
   5. numfds: Pointer to an integer number of "interesting" events occurred.
   Return value:
   - On success, returns CURLM_OK.
   - On failure, returns a CURLMcode error value.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">同样的，我们可以用<code>curl_mulri_strerror()</code>来查看发生了什么错误。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">curl_multi_strerror</span><span class="token punctuation">(</span>CURLMcode errornum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Returns a string describing the CURLMcode error.
   Parameters:
   1. errornum: The CURLMcode error value.
   Return value:
   - Returns a pointer to a null-terminated string describing the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.6 cURL Message" dir="auto" class="heading" id="2.3.6_cURL_Message"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.6 cURL Message</h4><div class="heading-children"><div class="el-p"><p dir="auto">当加入cURL multi的cURL easy handle完成传输任务后，curl multi就会将其添加到一个已完成传输的队列中。之后我们就可以通过<code>curl_multi_info_read()</code>读取easy handle的状态了。</p></div><div class="el-p"><p dir="auto"><code>curl_multi_info_read()</code>的函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLMsg <span class="token operator">*</span><span class="token function">curl_multi_info_read</span><span class="token punctuation">(</span>CURLM <span class="token operator">*</span>multi_handle<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>msgs_left<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Reads information about completed transfers.
   Parameters:
   1. multi_handle: The CURL multi handle.
   2. msgs_left: Pointer to an integer that will be set to the number of messages left in the queue.
   Return value:
   - On success, returns a pointer to a CURLMsg structure.
   - On failure, returns NULL.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">当读取成功时，<code>curl_multi_info_read()</code>会返回一个结构体并将所读取的curl easy从完成传输队列中移除。<code>CURLMsg</code>是一个结构体，用于提供有关传输完成的详细信息。它的原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    CURLMSG msg<span class="token punctuation">;</span>       <span class="token comment">/* What this message means */</span>
    CURL <span class="token operator">*</span>easy_handle<span class="token punctuation">;</span> <span class="token comment">/* The handle it concerns */</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>whatever<span class="token punctuation">;</span> <span class="token comment">/* Message-specific data */</span>
        CURLcode result<span class="token punctuation">;</span> <span class="token comment">/* Return code for transfer */</span>
    <span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span> CURLMsg<span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">这个结构体的第一个字段<code>CURLMSG</code>表示消息的类型。这是一个枚举类型，可能的值有<code>CURLMSG_DONE</code>表示传输完成和<code>CURLMSG_ERR</code>表示有发生错误。</p></div><div class="el-p"><p dir="auto">第二个字段表示与当前消息相关联的easy handle。</p></div><div class="el-p"><p dir="auto">第三个字段是一个联合体<code>data</code>，用于存储不同的类型，其中<code>CURLcode result;</code>表示curl easy传输的结果，我们前面见过。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.7 Remove Easy Handle" dir="auto" class="heading" id="2.3.7_Remove_Easy_Handle"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.7 Remove Easy Handle</h4><div class="heading-children"><div class="el-p"><p dir="auto">当一个easy handle完成后，我们就可以将它从multi handle中移除出去了。我们可以通过<code>msg-&gt;easy_handle</code>在结构体<code>CURLMsg</code>中获取到确切的easy_handle。然后通过相关的库函数将其移除并进行清理。（<code>curl_easy_cleanup(CURL* eh)</code>）</p></div><div class="el-p"><p dir="auto"><code>curl_multi_remove_handle()</code>的函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLMcode <span class="token function">curl_multi_remove_handle</span><span class="token punctuation">(</span>CURLM <span class="token operator">*</span>multi_handle<span class="token punctuation">,</span> CURL <span class="token operator">*</span>easy_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Removes an easy handle from a multi handle.
   Parameters:
   1. multi_handle: The CURL multi handle.
   2. easy_handle: The CURL easy handle to remove.
   Return value:
   - On success, returns CURLM_OK.
   - On failure, returns a CURLMcode error value, such as:
     - CURLM_BAD_HANDLE: The provided multi handle is invalid.
     - CURLM_BAD_EASY_HANDLE: The provided easy handle is invalid.
     - CURLM_OUT_OF_MEMORY: Memory allocation failed.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.8 CURLM Cleanup" dir="auto" class="heading" id="2.3.8_CURLM_Cleanup"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.8 CURLM Cleanup</h4><div class="heading-children"><div class="el-p"><p dir="auto">当我们不再需要curl multi时，就可以通过<code>curl_multi_cleanup()</code>将其清理掉，其函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLMcode <span class="token function">curl_multi_cleanup</span><span class="token punctuation">(</span>CURLM <span class="token operator">*</span>multi_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Cleans up a CURL multi handle.
   Parameters:
   1. multi_handle: The CURL multi handle to clean up.
   Return value:
   - On success, returns CURLM_OK.
   - On failure, returns a CURLMcode error value.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.9 cURL Multi Example" dir="auto" class="heading" id="2.3.9_cURL_Multi_Example"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.9 cURL Multi Example</h4><div class="heading-children"></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.10 Recycle, Reduce, Reuse" dir="auto" class="heading" id="2.3.10_Recycle,_Reduce,_Reuse"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.10 Recycle, Reduce, Reuse</h4><div class="heading-children"><div class="el-p"><p dir="auto">Reuse the curl easy handles all the time.</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.4 cURL + Select" dir="auto" class="heading" id="2.4_cURL_+_Select"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4 cURL + Select</h3><div class="heading-children"></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.5 cURL + epoll" dir="auto" class="heading" id="2.5_cURL_+_epoll"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5 cURL + epoll</h3><div class="heading-children"></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第三课 Asynchronous I/O with POSIX AIO" dir="auto" class="heading" id="第三课_Asynchronous_I/O_with_POSIX_AIO"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第三课 Asynchronous I/O with POSIX AIO</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">在学习异步 I/O 的过程中，我们希望 I/O 操作能够避免阻塞当前线程。然而，通过之前的学习，我们发现，尽管文件 fd 的读取涉及磁盘 I/O，与 socket 或 pipe 这类 fd 操作不同，文件操作通常能够确保数据始终可读。因此，即使将文件的 fd 设置为 <code>O_NONBLOCK</code>，它实际上仍然会导致阻塞。</p></div><div class="el-p"><p dir="auto">我们想要的是让文件加载到内存中之后再读，而不是阻塞硬控线程 5ms，该怎么办？POSIX AIO 闪亮登场！在发起文件 I/O 请求后，AIO 可以让线程立即返回，不被阻塞。并且当 I/O 操作完成时，通过回调或通知机制处理数据。完美！</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="AIO for Files" dir="auto" class="heading" id="AIO_for_Files"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>AIO for Files</h3><div class="heading-children"><div class="el-p"><p dir="auto">AIO 会创建一个 <code>aiocb</code> (AIO Control Block) 控制块，带有可选回调，这是一个操作描述符，管理 AIO 的具体操作（告诉操作系统你想要干什么）。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="AIOCB" dir="auto" class="heading" id="AIOCB"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>AIOCB</h4><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;aio.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">aiocb</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>             aio_fildes<span class="token punctuation">;</span>   <span class="token comment">/* File descriptor */</span>
    <span class="token class-name">off_t</span>           aio_offset<span class="token punctuation">;</span>   <span class="token comment">/* File offset */</span>
    <span class="token keyword">volatile</span> <span class="token keyword">void</span>  <span class="token operator">*</span>aio_buf<span class="token punctuation">;</span>      <span class="token comment">/* Buffer for data */</span>
    <span class="token class-name">size_t</span>          aio_nbytes<span class="token punctuation">;</span>   <span class="token comment">/* Number of bytes for I/O */</span>
    <span class="token keyword">int</span>             aio_reqprio<span class="token punctuation">;</span>  <span class="token comment">/* Request priority */</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigevent</span> aio_sigevent<span class="token punctuation">;</span> <span class="token comment">/* Signal or function to call when I/O completes */</span>
    <span class="token keyword">int</span>             aio_lio_opcode<span class="token punctuation">;</span> <span class="token comment">/* Operation to be performed (LIO_READ, LIO_WRITE, etc.) */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">sigevent</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>          sigev_notify<span class="token punctuation">;</span>              <span class="token comment">/* Notification type */</span>
    <span class="token keyword">int</span>          sigev_signo<span class="token punctuation">;</span>               <span class="token comment">/* Signal number (for signal-based notification) */</span>
    <span class="token keyword">union</span> sigval sigev_value<span class="token punctuation">;</span>               <span class="token comment">/* Data passed with notification */</span>
    <span class="token keyword">void</span>       <span class="token punctuation">(</span><span class="token operator">*</span>sigev_notify_function<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">union</span> sigval<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Callback function (if applicable) */</span>
    <span class="token keyword">void</span>        <span class="token operator">*</span>sigev_notify_attributes<span class="token punctuation">;</span>   <span class="token comment">/* Attributes for the thread (if using thread notification) */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">union</span> sigval <span class="token punctuation">{</span>
	<span class="token keyword">int</span>          sival_int<span class="token punctuation">;</span>
	<span class="token keyword">void</span><span class="token operator">*</span>        sival_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第四课 Libevent" dir="auto" class="heading" id="第四课_Libevent"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第四课 Libevent</h2><div class="heading-children"><div class="el-hr"><hr></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="`io_uring`" dir="auto" class="heading" id="`io_uring`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><code>io_uring</code></h2><div class="heading-children"><div class="el-hr"><hr></div><div class="mod-footer mod-ui"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#16. Asynchronous IO"><div class="tree-item-contents heading-link" heading-name="
Asynchronous IO
"><span class="tree-item-title">Asynchronous IO</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#第一课_Select,_Poll_and_Epoll"><div class="tree-item-contents heading-link" heading-name="第一课 Select, Poll and Epoll"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第一课 Select, Poll and Epoll</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.1_What_is_Asynchronous_I/O_Anyway?"><div class="tree-item-contents heading-link" heading-name="1.1 What is Asynchronous I/O Anyway?"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.1 What is Asynchronous I/O Anyway?</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.1.1_Resource_Wasting_Should_NOT_be_Allowed"><div class="tree-item-contents heading-link" heading-name="1.1.1 Resource Wasting Should NOT be Allowed"><span class="tree-item-title">1.1.1 Resource Wasting Should NOT be Allowed</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.1.2_Synchronous_I/O_Multiplexing"><div class="tree-item-contents heading-link" heading-name="1.1.2 Synchronous I/O Multiplexing"><span class="tree-item-title">1.1.2 Synchronous I/O Multiplexing</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2_select:_An_Old_Synchronous_I/O_Multiplexing_API"><div class="tree-item-contents heading-link" heading-name="1.2 select: An Old Synchronous I/O Multiplexing API"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.2 select: An Old Synchronous I/O Multiplexing API</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.1_Blocking_I/O_Operations"><div class="tree-item-contents heading-link" heading-name="1.2.1 Blocking I/O Operations"><span class="tree-item-title">1.2.1 Blocking I/O Operations</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.2_Non-Blocking_Sockets"><div class="tree-item-contents heading-link" heading-name="1.2.2 Non-Blocking Sockets"><span class="tree-item-title">1.2.2 Non-Blocking Sockets</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.3_Tight_Poll"><div class="tree-item-contents heading-link" heading-name="1.2.3 Tight Poll"><span class="tree-item-title">1.2.3 Tight Poll</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.4_Now_You_Select"><div class="tree-item-contents heading-link" heading-name="1.2.4 Now You Select"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.2.4 Now You Select</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.4.1_`nfds`"><div class="tree-item-contents heading-link" heading-name="1.2.4.1 `nfds`"><span class="tree-item-title">1.2.4.1 <code>nfds</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.4.2_File_Descriptor_Sets"><div class="tree-item-contents heading-link" heading-name="1.2.4.2 File Descriptor Sets"><span class="tree-item-title">1.2.4.2 File Descriptor Sets</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.4.3_Select:_The_Three_Easy_Pieces"><div class="tree-item-contents heading-link" heading-name="1.2.4.3 Select: The Three Easy Pieces"><span class="tree-item-title">1.2.4.3 Select: The Three Easy Pieces</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.4.4_The_Timeout"><div class="tree-item-contents heading-link" heading-name="1.2.4.4 The Timeout"><span class="tree-item-title">1.2.4.4 The Timeout</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.5_The_Changing_is_Painful"><div class="tree-item-contents heading-link" heading-name="1.2.5 The Changing is Painful"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.2.5 The Changing is Painful</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.5.1_FD_SETS"><div class="tree-item-contents heading-link" heading-name="1.2.5.1 FD_SETS"><span class="tree-item-title">1.2.5.1 FD_SETS</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.5.2_Time_Value"><div class="tree-item-contents heading-link" heading-name="1.2.5.2 Time Value"><span class="tree-item-title">1.2.5.2 Time Value</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.6_Check_the_Returned_Ones"><div class="tree-item-contents heading-link" heading-name="1.2.6 Check the Returned Ones"><span class="tree-item-title">1.2.6 Check the Returned Ones</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.2.7_Socket_Server"><div class="tree-item-contents heading-link" heading-name="1.2.7 Socket Server"><span class="tree-item-title">1.2.7 Socket Server</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.3_pselect"><div class="tree-item-contents heading-link" heading-name="1.3 pselect"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.3 pselect</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.3.1_timespec"><div class="tree-item-contents heading-link" heading-name="1.3.1 timespec"><span class="tree-item-title">1.3.1 timespec</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.3.2_sigmask"><div class="tree-item-contents heading-link" heading-name="1.3.2 sigmask"><span class="tree-item-title">1.3.2 sigmask</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.4_Poll:_An_Alternative_Select"><div class="tree-item-contents heading-link" heading-name="1.4 Poll: An Alternative Select"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.4 Poll: An Alternative Select</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.4.1_Poll_File_Descriptor"><div class="tree-item-contents heading-link" heading-name="1.4.1 Poll File Descriptor"><span class="tree-item-title">1.4.1 Poll File Descriptor</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.4.2_ERRNOs"><div class="tree-item-contents heading-link" heading-name="1.4.2 ERRNOs"><span class="tree-item-title">1.4.2 ERRNOs</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.4.4_3-Service_Example_with_`poll()`"><div class="tree-item-contents heading-link" heading-name="1.4.4 3-Service Example with `poll()`"><span class="tree-item-title">1.4.4 3-Service Example with <code>poll()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.5_ppoll"><div class="tree-item-contents heading-link" heading-name="1.5 ppoll"><span class="tree-item-title">1.5 ppoll</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6_epoll:_I/O_Event_Notification_Facility"><div class="tree-item-contents heading-link" heading-name="1.6 epoll: I/O Event Notification Facility"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.6 epoll: I/O Event Notification Facility</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6.1_epoll_Instance"><div class="tree-item-contents heading-link" heading-name="1.6.1 epoll Instance"><span class="tree-item-title">1.6.1 epoll Instance</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6.2_Why's_epoll_This_Darn_Fast"><div class="tree-item-contents heading-link" heading-name="1.6.2 Why's epoll This Darn Fast"><span class="tree-item-title">1.6.2 Why's epoll This Darn Fast</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6.3_Create_and_Manage_an_epoll_Instance"><div class="tree-item-contents heading-link" heading-name="1.6.3 Create and Manage an epoll Instance"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.6.3 Create and Manage an epoll Instance</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#epoll_Instance_Creation:_`epoll_create`_and_`epoll_create1`"><div class="tree-item-contents heading-link" heading-name="epoll Instance Creation: `epoll_create` and `epoll_create1`"><span class="tree-item-title">epoll Instance Creation: <code>epoll_create</code> and <code>epoll_create1</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#epoll_Instance_Control"><div class="tree-item-contents heading-link" heading-name="epoll Instance Control"><span class="tree-item-title">epoll Instance Control</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6.4_Waiting_for_I/O_Events_to_Happen"><div class="tree-item-contents heading-link" heading-name="1.6.4 Waiting for I/O Events to Happen"><span class="tree-item-title">1.6.4 Waiting for I/O Events to Happen</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6.5_Level-Triggered_and_Edge-Triggered_Events"><div class="tree-item-contents heading-link" heading-name="1.6.5 Level-Triggered and Edge-Triggered Events"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.6.5 Level-Triggered and Edge-Triggered Events</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#Level-Triggered"><div class="tree-item-contents heading-link" heading-name="Level-Triggered"><span class="tree-item-title">Level-Triggered</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#Edge-Triggered"><div class="tree-item-contents heading-link" heading-name="Edge-Triggered"><span class="tree-item-title">Edge-Triggered</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#One_Shot_Mechanism"><div class="tree-item-contents heading-link" heading-name="One Shot Mechanism"><span class="tree-item-title">One Shot Mechanism</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#Thundering_Herd"><div class="tree-item-contents heading-link" heading-name="Thundering Herd"><span class="tree-item-title">Thundering Herd</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6.6_System_Auto_Sleep"><div class="tree-item-contents heading-link" heading-name="1.6.6 System Auto Sleep"><span class="tree-item-title">1.6.6 System Auto Sleep</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#1.6.7_Best_Practice"><div class="tree-item-contents heading-link" heading-name="1.6.7 Best Practice"><span class="tree-item-title">1.6.7 Best Practice</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#第二课_cURL"><div class="tree-item-contents heading-link" heading-name="第二课 cURL"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第二课 cURL</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.1_cURL_Global"><div class="tree-item-contents heading-link" heading-name="2.1 cURL Global"><span class="tree-item-title">2.1 cURL Global</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.2_cURL_Easy_Interface"><div class="tree-item-contents heading-link" heading-name="2.2 cURL Easy Interface"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.2 cURL Easy Interface</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.2.1_EZ_Initialization_and_EZ_Option_Setting"><div class="tree-item-contents heading-link" heading-name="2.2.1 EZ Initialization and EZ Option Setting"><span class="tree-item-title">2.2.1 EZ Initialization and EZ Option Setting</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.2.2_Easy_Perform"><div class="tree-item-contents heading-link" heading-name="2.2.2 Easy Perform"><span class="tree-item-title">2.2.2 Easy Perform</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.2.3_EZ_Cleanup"><div class="tree-item-contents heading-link" heading-name="2.2.3 EZ Cleanup"><span class="tree-item-title">2.2.3 EZ Cleanup</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.2.4_Error_Checking"><div class="tree-item-contents heading-link" heading-name="2.2.4 Error Checking"><span class="tree-item-title">2.2.4 Error Checking</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.2.5_An_Example"><div class="tree-item-contents heading-link" heading-name="2.2.5 An Example"><span class="tree-item-title">2.2.5 An Example</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3_cURL_Multi:_A_Easy_Manager"><div class="tree-item-contents heading-link" heading-name="2.3 cURL Multi: A Easy Manager"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.3 cURL Multi: A Easy Manager</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.1_cURL_Multi_Interface"><div class="tree-item-contents heading-link" heading-name="2.3.1 cURL Multi Interface"><span class="tree-item-title">2.3.1 cURL Multi Interface</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.2_Multi-Init"><div class="tree-item-contents heading-link" heading-name="2.3.2 Multi-Init"><span class="tree-item-title">2.3.2 Multi-Init</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.3_Add_EZ_Handle"><div class="tree-item-contents heading-link" heading-name="2.3.3 Add EZ Handle"><span class="tree-item-title">2.3.3 Add EZ Handle</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.4_Easy_Handles_Dispatch"><div class="tree-item-contents heading-link" heading-name="2.3.4 Easy Handles Dispatch"><span class="tree-item-title">2.3.4 Easy Handles Dispatch</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.5_Maybe_A_Bit_of_Naps?"><div class="tree-item-contents heading-link" heading-name="2.3.5 Maybe A Bit of Naps?"><span class="tree-item-title">2.3.5 Maybe A Bit of Naps?</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.6_cURL_Message"><div class="tree-item-contents heading-link" heading-name="2.3.6 cURL Message"><span class="tree-item-title">2.3.6 cURL Message</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.7_Remove_Easy_Handle"><div class="tree-item-contents heading-link" heading-name="2.3.7 Remove Easy Handle"><span class="tree-item-title">2.3.7 Remove Easy Handle</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.8_CURLM_Cleanup"><div class="tree-item-contents heading-link" heading-name="2.3.8 CURLM Cleanup"><span class="tree-item-title">2.3.8 CURLM Cleanup</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.9_cURL_Multi_Example"><div class="tree-item-contents heading-link" heading-name="2.3.9 cURL Multi Example"><span class="tree-item-title">2.3.9 cURL Multi Example</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.3.10_Recycle,_Reduce,_Reuse"><div class="tree-item-contents heading-link" heading-name="2.3.10 Recycle, Reduce, Reuse"><span class="tree-item-title">2.3.10 Recycle, Reduce, Reuse</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.4_cURL_+_Select"><div class="tree-item-contents heading-link" heading-name="2.4 cURL + Select"><span class="tree-item-title">2.4 cURL + Select</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#2.5_cURL_+_epoll"><div class="tree-item-contents heading-link" heading-name="2.5 cURL + epoll"><span class="tree-item-title">2.5 cURL + epoll</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#第三课_Asynchronous_I/O_with_POSIX_AIO"><div class="tree-item-contents heading-link" heading-name="第三课 Asynchronous I/O with POSIX AIO"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第三课 Asynchronous I/O with POSIX AIO</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#AIO_for_Files"><div class="tree-item-contents heading-link" heading-name="AIO for Files"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">AIO for Files</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#AIOCB"><div class="tree-item-contents heading-link" heading-name="AIOCB"><span class="tree-item-title">AIOCB</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#第四课_Libevent"><div class="tree-item-contents heading-link" heading-name="第四课 Libevent"><span class="tree-item-title">第四课 Libevent</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="congzhi's-os-series\16.-asynchronous-io.html#`io_uring`"><div class="tree-item-contents heading-link" heading-name="`io_uring`"><span class="tree-item-title"><code>io_uring</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>